<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Control Stock - Buenos Aires</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="manifest" href='data:application/manifest+json,{"name":"Control Stock Buenos Aires","short_name":"Stock BA","start_url":"./","display":"standalone","background_color":"#111827","theme_color":"#111827"}'>
    <meta name="theme-color" content="#111827">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root { font-size: 17px; line-height: 1.5; }
        body {
            background-color: #121212;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: #f5f5f5;
            padding-bottom: 70px;
        }
        button:focus-visible, a:focus-visible {
            outline: 3px solid #facc15;
            outline-offset: 2px;
        }
        .navbar { background: #1f2933; }
        .nav-pills .nav-link {
            background-color: #111827;
            color: #e5e7eb;
            font-size: 0.95rem;
        }
        .nav-pills .nav-link.active { background-color: #2563eb; }
        .card {
            background: #1e1e1e;
            color: #f5f5f5;
            border-radius: 1rem;
            border: 2px solid #374151;
        }
        .paciente-card { margin-bottom: 1.5rem; border-radius: 1rem; }
        .planilla-inner-table { font-size: 0.9rem; }
        .planilla-inner-table th, .planilla-inner-table td { border-width: 2px !important; }
        .table-responsive { font-size: 0.8rem; }
        .stock-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        @media (max-width: 768px) {
            h3 { font-size: 1.1rem; }
            .navbar-brand { font-size: 1rem; }
            #tabla-stock-table { min-width: 650px; }
            #tabla-stock-table th, #tabla-stock-table td { white-space: nowrap; }
        }
        .dia-count {
            font-size: 0.95rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.6rem;
            color: #111827;
            display: inline-block;
            border: 1px solid #0f172a;
            font-weight: 600;
        }
        .modal-content {
            background-color: #1e1e1e;
            color: #f5f5f5;
            border-radius: 1rem;
            border-width: 2px;
        }
        .form-control {
            background-color: #111827;
            border-color: #4b5563;
            color: #f9fafb;
            font-size: 0.9rem;
        }
        .form-control:focus {
            background-color: #111827;
            color: #f9fafb;
            border-color: #facc15;
            box-shadow: 0 0 0 0.15rem rgba(250, 204, 21, 0.35);
        }
        .btn { font-size: 0.95rem; border-radius: 999px; }
        .temp-med-row { background-color: rgba(250, 204, 21, 0.18); }
        .temp-med-border { border-color: #eab308 !important; }
        .avatar-circle {
            width: 44px; height: 44px; border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-weight: 600; color: #f9fafb; margin-right: 0.75rem; flex-shrink: 0;
            border: 2px solid #4b5563;
        }
        .bottom-nav { display: none; }
        @media (max-width: 768px) {
            .bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; right: 0;
                background-color: #020617; border-top: 1px solid #374151; z-index: 1030;
            }
            .bottom-nav .nav-link {
                flex: 1; text-align: center; padding: 0.7rem 0.2rem;
                font-size: 0.85rem; color: #9ca3af; border-radius: 0;
            }
            .bottom-nav .nav-link span { display: block; font-size: 1.1rem; }
            .bottom-nav .nav-link.active {
                color: #f9fafb; background-color: #111827;
            }
        }
        @media print {
            @page { size: A4 portrait; margin: 1cm; }
            body { background: #ffffff; color: #000000; padding-bottom: 0; }
            .navbar,.nav,.btn,#modalPaciente,#modalDetallePaciente,#modalHistorialStock,
            #modalCarrito,#modalAccionesStock,#modalNuevoMed,.bottom-nav { display:none!important; }
            .card.paciente-card { break-inside: avoid; box-shadow:none!important; border-color:#000!important; }
            #tab-stock { display:none!important; }
        }
        .btn-icon {
            width: 44px; height: 44px; padding: 0;
            display:inline-flex; align-items:center; justify-content:center;
            border-radius:999px;
        }
        .btn-icon:hover { background-color:#1d4ed8; border-color:#1d4ed8; }
        .btn-icon:active { background-color:#1e40af; border-color:#1e40af; }
        .acciones-stock-btn {
            border-radius:0.9rem; border-width:2px; font-size:1rem;
            padding:0.85rem 1rem; text-align:left;
            display:flex; align-items:center; gap:0.6rem;
        }
        .acciones-stock-btn span.icono { font-size:1.2rem; }
        .acciones-stock-btn.is-active-touch { outline:3px solid #facc15; outline-offset:1px; }
        .btn-accion-editar { background-color:#1d4ed8; border-color:#1d4ed8; color:#f9fafb; }
        .btn-accion-agregar { background-color:#15803d; border-color:#15803d; color:#f9fafb; }
        .btn-accion-descontar { background-color:#b91c1c; border-color:#b91c1c; color:#f9fafb; }
        .btn-accion-historial { background-color:#0f172a; border-color:#4b5563; color:#e5e7eb; }
        .btn-accion-historial:hover { background-color:#111827; }
        .btn-accion-paciente { font-weight:500; border-radius:999px; }
        .btn-accion-paciente:focus-visible { outline:3px solid #facc15; outline-offset:2px; }


        /* Pantalla de bloqueo login */
/* Nuevo dise√±o para la pantalla de inicio de sesi√≥n */
#login-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle, #1f2937 0%, #111827 100%);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.login-card {
    width: 100%; max-width: 400px;
    padding: 2.5rem;
    background: #1e1e1e;
    border-radius: 2rem;
    border: 1px solid #374151;
    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
}

.input-group-text {
    background-color: #111827;
    border-color: #4b5563;
    color: #9ca3af;
    cursor: pointer;
    transition: color 0.3s ease;
}

.input-group-text:hover {
    color: #facc15;
}

.form-check-input:checked {
    background-color: #2563eb;
    border-color: #2563eb;
}

/* Ocultar bot√≥n test por defecto */
#btn-test-container {
    display: none;
}

/* --- NUEVOS ESTILOS PARA FRECUENCIAS --- */
.med-row-hoy {
    background-color: rgba(22, 163, 74, 0.15) !important; /* Verde suave */
    border-left: 4px solid #16a34a !important;
}
.med-row-descanso {
    opacity: 0.6;
    background-color: rgba(55, 65, 81, 0.3); /* Gris√°ceo */
    border-left: 4px solid #4b5563 !important;
    font-style: italic;
}
.freq-badge {
    font-size: 0.65rem;
    padding: 1.5px 5px;
    border-radius: 4px;
    background: #374151;
    color: #e5e7eb;
    margin-left: 7px;
    display: inline-block;
}
.freq-controls {
    background-color: #1f2937;
    padding: 0.6rem;
    border-radius: 0.5rem;
    margin-top: 0.5rem;
    border: 1px dashed #4b5563;
}
    </style>
</head>
<body>

    <div id="login-overlay">
    <div class="login-card text-center">
        <div class="mb-4">
            <span style="font-size: 3rem;">üîê</span>
            <h4 class="mt-2 fw-bold">Acceso al Sistema</h4>
            <p class="text-muted small">Por favor, introduce tus credenciales</p>
        </div>
        
        <div class="mb-3 text-start">
            <label for="user-input" class="form-label small fw-semibold text-secondary">Usuario</label>
            <input type="text" id="user-input" class="form-control" placeholder="Ej: Administrador">
        </div>

        <div class="mb-3 text-start">
            <label for="pass-input" class="form-label small fw-semibold text-secondary">Contrase√±a</label>
            <div class="input-group">
                <input type="password" id="pass-input" class="form-control" placeholder="Ingresa tu clave">
                <span class="input-group-text" onclick="togglePassword()">
                    <span id="eye-icon">üëÅÔ∏è</span>
                </span>
            </div>
        </div>

        <div class="mb-4 text-start d-flex justify-content-between">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="remember-me">
                <label class="form-check-label small text-muted" for="remember-me">
                    Recordar sesi√≥n
                </label>
            </div>
        </div>

        <button class="btn btn-primary w-100 py-2 fw-bold" onclick="verificarLogin()">
            Iniciar Sesi√≥n
        </button>

        <div id="login-error" class="text-danger small mt-3 animate__animated animate__shakeX" style="display:none;">
            ‚ö†Ô∏è Credenciales incorrectas
        </div>
    </div>
</div>



<nav class="navbar navbar-dark mb-4 p-3">
    <div class="container d-flex justify-content-between">
       <span class="navbar-brand" id="titulo-secreto" style="cursor: default; user-select: none;">
    üè• Control Stock - Los logros
</span>
    <div class="d-flex gap-2">
            <div id="btn-test-container">
                <button class="btn btn-outline-danger" onclick="abrirSimuladorTiempo()" title="Simular paso del tiempo">
                    <span>‚è≥</span> Test
                </button>
                </div>
             <button class="btn btn-outline-warning" onclick="mostrarAyuda()" title="Gu√≠a de uso">
            <span>‚ùì</span> Ayuda
        </button>
        <button class="btn btn-outline-success" onclick="descargarPacientesCSV()" title="Descargar Excel (CSV)">
        <span>üìä</span> CSV
    </button>
        <button class="btn btn-outline-info" onclick="descargarDatosJSON()" title="Descargar Backup JSON">
        <span>üì•</span> Exportar
    </button>
    </div>
        <div id="status-indicator" class="text-white small">Cargando...</div>
    </div>
</nav>

<div class="container">
    <ul class="nav nav-pills mb-4 d-none d-md-flex">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-pats" id="tab-btn-pats-top">üë• Pacientes</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-stock" id="tab-btn-stock-top">üì¶ Stock e Inventario</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-pats">
            <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
                <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center">
                    <h3 class="mb-0">Pacientes</h3>
                    <input
                        type="text"
                        id="buscador-pacientes"
                        class="form-control form-control-sm"
                        placeholder="Buscar paciente..."
                        aria-label="Buscar paciente por nombre o DNI">
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-light btn-sm" type="button" onclick="ordenarPacientesAlfabetico()">
                        ‚ÜïÔ∏è Ordenar A-Z
                    </button>
                    <button class="btn btn-primary" type="button" onclick="abrirModal()">+ Registrar Paciente</button>
                    <button class="btn btn-outline-light" type="button" onclick="imprimirPlanilla()">üñ® Imprimir A4</button>
                </div>
            </div>
            <div id="lista-pacientes-planilla"></div>
        </div>

        <div class="tab-pane fade" id="tab-stock">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <h3>Estado de Suministros</h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" type="button" onclick="abrirModalNuevoMed()">
                        ‚ûï Nuevo medicamento
                    </button>
                    <button class="btn btn-warning btn-sm" type="button" onclick="abrirCarrito()">üõí Ver carrito</button>
                </div>
            </div>
            <div class="card p-3 shadow-sm rounded-4">
                <div class="table-responsive rounded-4 stock-wrapper">
                    <table class="table align-middle mt-1 table-dark table-sm table-bordered mb-0" id="tabla-stock-table">
                        <thead>
                            <tr>
                                <th>Droga</th>
                                <th>Presentaci√≥n</th>
                                <th>Stock</th>
                                <th>Consumo/d√≠a (comp.)</th>
                                <th>D√≠as / Fecha fin</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-stock"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<nav class="bottom-nav nav justify-content-around">
    <button class="nav-link active" id="tab-btn-pats-bottom" onclick="activarTab('tab-pats')">
        <span>üë•</span>
        Pacientes
    </button>
    <button class="nav-link" id="tab-btn-stock-bottom" onclick="activarTab('tab-stock')">
        <span>üì¶</span>
        Stock
    </button>
</nav>

<!-- MODAL ACCIONES STOCK -->
<div class="modal fade" id="modalAccionesStock" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="acciones-stock-title">Acciones de stock</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <button class="btn acciones-stock-btn btn-accion-editar w-100 mb-2" id="btn-accion-editar">
            <span class="icono">‚úèÔ∏è</span>
            <span>Editar stock</span>
        </button>
        <button class="btn acciones-stock-btn btn-accion-agregar w-100 mb-2" id="btn-accion-agregar">
            <span class="icono">‚ûï</span>
            <span>Agregar stock</span>
        </button>
        <button class="btn acciones-stock-btn btn-accion-descontar w-100 mb-2" id="btn-accion-descontar">
            <span class="icono">‚ûñ</span>
            <span>Descontar stock</span>
        </button>
        <button class="btn acciones-stock-btn btn-accion-historial w-100" id="btn-accion-historial">
            <span class="icono">üìú</span>
            <span>Ver historial</span>
        </button>
        <hr class="border-secondary my-2">
        <button class="btn acciones-stock-btn w-100" id="btn-accion-borrar-med" style="background-color: #7f1d1d; border-color: #7f1d1d; color: #fecaca;">
            <span class="icono">üóë</span>
            <span>Eliminar medicamento</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PACIENTE -->
<div class="modal fade" id="modalPaciente" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 id="modalTitle">Nuevo Registro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <input type="text" id="in-nombre" class="form-control mb-2" placeholder="Nombre completo">
                <input type="text" id="in-dni" class="form-control mb-2" placeholder="DNI">
                <input type="text" id="in-alergias" class="form-control mb-3" placeholder="Alergias (texto libre)">
                <h6>Prescripciones:</h6>
                <p class="small text-muted mb-1">
                    Dosis = mg de cada comprimido (ej. 100). La dosis diaria se calcula autom√°ticamente multiplicando por los comprimidos de cada turno.
                </p>
                <div id="lista-prescripciones"></div>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="nuevaFila()">+ Otra droga</button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-100" id="btn-guardar-paciente" onclick="guardarPaciente()">
                    Guardar Cambios
                </button>
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DETALLE PACIENTE -->
<div class="modal fade" id="modalDetallePaciente" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 id="detalle-title">Detalle del paciente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Nombre:</strong> <span id="detalle-nombre"></span></p>
        <p><strong>DNI:</strong> <span id="detalle-dni"></span></p>
        <p><strong>Alergias:</strong> <span id="detalle-alergias"></span></p>
        <p><strong>√öltima actualizaci√≥n:</strong> <span id="detalle-last"></span></p>
        <hr>
        <h6>Esquema de medicaci√≥n</h6>
        <div id="detalle-prescripciones"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL STOCK -->
<div class="modal fade" id="modalHistorialStock" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 id="historial-title">Historial de stock</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="historial-contenido"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CARRITO -->
<div class="modal fade" id="modalCarrito" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5>üõí Carrito de reposici√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="small mb-2">
          Medicamentos con menos de 5 d√≠as de cobertura. Se sugiere reponer hasta 10 d√≠as (cantidad calculada).
        </p>
        <ul id="carrito-lista" class="small mb-3"></ul>
        <button class="btn btn-dark w-100 mb-1" onclick="copiarCarrito()">Copiar faltantes</button>
        <div id="carrito-msg" class="small text-success mt-1"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL NUEVO MEDICAMENTO -->
<div class="modal fade" id="modalNuevoMed" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Nuevo medicamento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="med-nombre" class="form-control mb-2 fixed" placeholder="Nombre (droga)">
        <input type="text" id="med-strength" class="form-control mb-2 fixed" placeholder="Presentaci√≥n (ej. 100 mg)">
        <input type="number" min="0" id="med-stock" class="form-control mb-2 fixed" placeholder="Stock inicial (comprimidos)">
        <label class="small text-muted mb-1">Consumo diario manual (opcional):</label>
        <input type="number" step="0.01" min="0" id="med-manual-consumption" class="form-control mb-2 fixed" placeholder="Ej: 2.5 (deja vac√≠o para auto-calcular)">
        <p class="small text-muted" style="font-size: 0.75rem;">Si ingresas un valor aqu√≠, se usar√° este en lugar de sumar lo de los pacientes.</p>
      </div>
      <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" onclick="guardarNuevoMed()">Guardar Medicamento</button>
      </div>
    </div>
  </div>
</div>

<datalist id="lista-meds-sugeridos"></datalist>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    // Credenciales solicitadas
const CREDENCIALES = {
    user: "Loslogros1987",
    pass: "Lezica881luzuriaga"
};

// Funci√≥n de verificaci√≥n
// Funci√≥n para mostrar/ocultar contrase√±a
function togglePassword() {
    const passInput = document.getElementById('pass-input');
    const eyeIcon = document.getElementById('eye-icon');
    if (passInput.type === "password") {
        passInput.type = "text";
        eyeIcon.innerText = "üôà"; // Cambia el icono
    } else {
        passInput.type = "password";
        eyeIcon.innerText = "üëÅÔ∏è";
    }
}

// Funci√≥n de verificaci√≥n actualizada
function verificarLogin() {
    const u = document.getElementById('user-input').value;
    const p = document.getElementById('pass-input').value;
    const remember = document.getElementById('remember-me').checked;
    const errorDiv = document.getElementById('login-error');

    if (u === CREDENCIALES.user && p === CREDENCIALES.pass) {
        // Si "Recordar" est√° marcado, usamos localStorage (persiste al cerrar navegador)
        // Si no, usamos sessionStorage (se borra al cerrar)
        const storage = remember ? localStorage : sessionStorage;
        storage.setItem('auth_stock_ba', 'true');
        
        document.getElementById('login-overlay').style.display = 'none';
        iniciar();
    } else {
        errorDiv.style.display = 'block';
        setTimeout(() => { errorDiv.style.display = 'none'; }, 3000);
    }
}

const URL_BASE = 'https://695f043a7f037703a81290ad.mockapi.io/api/v1';
const RES_MEDS = 'Medications';
const RES_PATS = 'Patients';

let listadoMeds = [];
let listadoPats = [];
let modoOffline = true;

const DIAS_MINIMOS = 5;
const DIAS_OBJETIVO = 10;

let medAccionesActualId = null;
let filtroPacientes = '';
let pacienteArrastradoId = null;




/* Utils */
/* Utils: Correcci√≥n de decimales */
function parseDecimal(value) {
    if (value === null || value === undefined || value === '') return 0;
    if (typeof value === 'number') return value;
    // Elimina cualquier cosa que no sea n√∫mero, punto o coma, 
    // luego cambia coma por punto y limpia espacios.
    const s = String(value).replace(/[^0-9.,]/g, '').replace(',', '.').trim();
    const n = parseFloat(s);
    return Number.isNaN(n) ? 0 : n;
}
function getInitials(name) {
    if (!name) return '?';
    const parts = name.trim().split(/\s+/);
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    const first = parts[0].charAt(0).toUpperCase();
    const last = parts[parts.length - 1].charAt(0).toUpperCase();
    return first + last;
}
function getAvatarColor(name) {
    // array limpio, sin caracteres extra√±os
    const colors = ['#ef4444','#f97316','#eab308','#22c55e','#0ea5e9','#6366f1','#a855f7','#ec4899'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    const index = Math.abs(hash) % colors.length;
    return colors[index];
}

/* Tabs bottom */
function activarTab(id) {
    const selector = '[data-bs-toggle="pill"][data-bs-target="#' + id + '"]';
    const tabElement = document.querySelector(selector);
    if (tabElement) {
        const tab = new bootstrap.Tab(tabElement);
        tab.show();
    }
    const btnPatsBottom = document.getElementById('tab-btn-pats-bottom');
    const btnStockBottom = document.getElementById('tab-btn-stock-bottom');
    btnPatsBottom.classList.remove('active');
    btnStockBottom.classList.remove('active');
    if (id === 'tab-pats') btnPatsBottom.classList.add('active');
    if (id === 'tab-stock') btnStockBottom.classList.add('active');
}
document.addEventListener('shown.bs.tab', function (event) {
    const targetId = event.target.getAttribute('data-bs-target');
    if (targetId === '#tab-pats') activarTab('tab-pats');
    if (targetId === '#tab-stock') activarTab('tab-stock');
});

/* LocalStorage helpers */
function usarCargaLocal() {
    listadoMeds = JSON.parse(localStorage.getItem('local_meds')) || [];
    listadoPats = JSON.parse(localStorage.getItem('local_pats')) || [];
    document.getElementById('status-indicator').innerText = "Modo Local";
}
function persistirLocal() {
    localStorage.setItem('local_meds', JSON.stringify(listadoMeds));
    localStorage.setItem('local_pats', JSON.stringify(listadoPats));
}

/* Descuento autom√°tico diario al abrir la app */
const DAILY_KEY = 'ultima_actualizacion_stock';
async function aplicarDescuentoDiario() {
    const hoy = new Date();
    const hoyYmd = hoy.toISOString().substring(0,10);
    const ultima = localStorage.getItem(DAILY_KEY);

    if (ultima === hoyYmd) return;

    let diasPasados = 1;
    if (ultima) {
        const dUltima = new Date(ultima + 'T00:00:00');
        const diffMs = hoy.getTime() - dUltima.getTime();
        diasPasados = Math.max(1, Math.floor(diffMs / (1000*60*60*24)));
    }

    listadoMeds.forEach(m => {
        const consumo = calcularConsumoCompPorMed(m);
        if (consumo <= 0) return;
        const stockActual = parseDecimal(m.stock);
        if (stockActual <= 0) return;
        const descuento = consumo * diasPasados;
        const nuevoStock = Math.max(0, stockActual - descuento);
        const cambio = nuevoStock - stockActual;
        if (cambio === 0) return;

        m.stock = nuevoStock;
        m.stockHistory = m.stockHistory || [];
        m.stockHistory.push({
            date: new Date().toISOString(),
            change: cambio,
            newStock: nuevoStock,
            type: 'auto-day'
        });
    });

    localStorage.setItem(DAILY_KEY, hoyYmd);
    persistirLocal();
}

/* Carga inicial optimizada */
async function iniciar() {
    usarCargaLocal();
    inicializarModalAccionesStock();
    inicializarBuscadorPacientes();

    await aplicarDescuentoDiario();
    renderizar();
    actualizarDatalistMeds();

    try {
        const [rM, rP] = await Promise.all([
            fetch(URL_BASE + '/' + RES_MEDS),
            fetch(URL_BASE + '/' + RES_PATS)
        ]);
        if (rM.ok && rP.ok) {
            const medsApi = await rM.json();
            const patsApi = await rP.json();
            listadoMeds = medsApi;
            listadoPats = patsApi;
            modoOffline = false;

            await aplicarDescuentoDiario();

            document.getElementById('status-indicator').innerText = "Modo Online (API)";
            persistirLocal();
            renderizar();
            actualizarDatalistMeds();
        } else {
            document.getElementById('status-indicator').innerText = "Modo Local (Error API)";
        }
    } catch (e) {
        document.getElementById('status-indicator').innerText = "Modo Local (Sin conexi√≥n)";
    }
}

function renderizar() {
    renderPacientesPlanilla();
    renderStock();
}
function imprimirPlanilla() { window.print(); }

/* Buscador + orden */
function inicializarBuscadorPacientes() {
    const input = document.getElementById('buscador-pacientes');
    if (input) {
        input.addEventListener('input', () => {
            filtroPacientes = input.value.trim().toLowerCase();
            renderPacientesPlanilla();
        });
    }
}
function ordenarPacientesAlfabetico() {
    listadoPats.sort((a, b) => {
        const an = (a.name || '').toLowerCase();
        const bn = (b.name || '').toLowerCase();
        if (an < bn) return -1;
        if (an > bn) return 1;
        return 0;
    });
    persistirLocal();
    renderPacientesPlanilla();
}

/* Drag & drop pacientes */
function dragPacienteStart(ev) {
    const id = ev.currentTarget.getAttribute('data-paciente-id');
    pacienteArrastradoId = id;
    if (ev.dataTransfer) ev.dataTransfer.effectAllowed = 'move';
}
function dragPacienteOver(ev) {
    ev.preventDefault();
    if (ev.dataTransfer) ev.dataTransfer.dropEffect = 'move';
}
function dragPacienteDrop(ev) {
    ev.preventDefault();
    const targetCard = ev.currentTarget;
    const targetId = targetCard.getAttribute('data-paciente-id');
    if (!pacienteArrastradoId || !targetId || pacienteArrastradoId === targetId) return;

    const fromIndex = listadoPats.findIndex(p => p.id == pacienteArrastradoId);
    const toIndex = listadoPats.findIndex(p => p.id == targetId);
    if (fromIndex === -1 || toIndex === -1) return;

    const [movido] = listadoPats.splice(fromIndex, 1);
    listadoPats.splice(toIndex, 0, movido);

    persistirLocal();
    renderPacientesPlanilla();
}

/* Pacientes */
function renderPacientesPlanilla() {
    const cont = document.getElementById('lista-pacientes-planilla');

    const filtrados = listadoPats.filter(p => {
        if (!filtroPacientes) return true;
        const nombre = (p.name || '').toLowerCase();
        const dni = (p.dni || '').toLowerCase();
        return nombre.includes(filtroPacientes) || dni.includes(filtroPacientes);
    });

    cont.innerHTML = filtrados.map(p => {
        const lastTxt = p.lastUpdated
            ? new Date(p.lastUpdated).toLocaleString('es-AR')
            : 'Sin registro';
        const nombre = p.name || '';
        const alergiasTxt = (p.allergies || '').trim();
        const alergiasMostrar = alergiasTxt ? '‚ö†Ô∏è ' + alergiasTxt : 'Sin datos';
        const initials = getInitials(nombre);
        const avatarColor = getAvatarColor(nombre);

        return '' +
        '<div class="card paciente-card shadow-sm p-3 p-md-4 border-2" ' +
            'draggable="true" ' +
            'data-paciente-id="' + p.id + '" ' +
            'ondragstart="dragPacienteStart(event)" ' +
            'ondragover="dragPacienteOver(event)" ' +
            'ondrop="dragPacienteDrop(event)">' +
          '<div class="d-flex justify-content-between flex-wrap gap-2 mb-2">' +
            '<div class="d-flex align-items-start">' +
              '<div class="avatar-circle" style="background-color:' + avatarColor + ';">' +
                initials +
              '</div>' +
              '<div>' +
                '<div class="fw-semibold" style="font-size:1rem;">' + nombre + '</div>' +
                '<div class="small text-muted">DNI: ' + (p.dni || '') + '</div>' +
                '<div class="small text-muted">Alergias: ' + alergiasMostrar + '</div>' +
                '<div class="small text-muted mt-1">√öltima actualizaci√≥n: ' + lastTxt + '</div>' +
              '</div>' +
            '</div>' +
            '<div class="d-flex gap-2 flex-wrap">' +
              '<button class="btn btn-light btn-sm btn-accion-paciente" type="button" onclick="abrirEdicion(\'' + p.id + '\')">‚úèÔ∏è Editar</button>' +
              '<button class="btn btn-info btn-sm btn-accion-paciente" type="button" onclick="verDetallePaciente(\'' + p.id + '\')">üëÅ Detalle</button>' +
              '<button class="btn btn-danger btn-sm btn-accion-paciente" type="button" onclick="eliminarP(\'' + p.id + '\')">üóë Borrar</button>' +
            '</div>' +
          '</div>' +
          '<div class="table-responsive rounded-4">' +
            '<table class="table table-dark table-sm table-bordered mb-0 planilla-inner-table">' +
              '<thead>' +
                '<tr>' +
                  '<th>Medicaci√≥n</th>' +
                  '<th>Dosis total (mg/d√≠a)</th>' +
                  '<th>Ma√±ana (comp.)</th>' +
                  '<th>Tarde (comp.)</th>' +
                  '<th>Noche (comp.)</th>' +
                  '<th>Total d√≠a (comp.)</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' +
                ((p.prescriptions || []).length
                  ? (p.prescriptions || []).map(pr => {
                        const mTabs = parseDecimal(pr.morningTabs);
                        const aTabs = parseDecimal(pr.afternoonTabs);
                        const nTabs = parseDecimal(pr.nightTabs);
                        const totalTabs = mTabs + aTabs + nTabs;
                        const dosisDia = parseDecimal(pr.dailyDosageMg);
                        const tempClass = pr.isTemporary ? 'temp-med-row temp-med-border' : '';
                        const labelTemp = pr.isTemporary ? ' (TEMP)' : '';
                        return '' +
                        '<tr class="' + tempClass + '">' +
                          '<td>' + (pr.medName || '') + (pr.strength ? ' (' + pr.strength + ')' : '') + labelTemp + '</td>' +
                          '<td>' + dosisDia + '</td>' +
                          '<td>' + mTabs + '</td>' +
                          '<td>' + aTabs + '</td>' +
                          '<td>' + nTabs + '</td>' +
                          '<td>' + totalTabs + '</td>' +
                        '</tr>';
                    }).join('')
                  : '<tr><td colspan="6" class="small text-muted text-center">Sin prescripciones</td></tr>'
                ) +
              '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>';
    }).join('');
}

/* Stock */
/* Reemplaza la funci√≥n completa con este bloque */
function calcularConsumoCompPorMed(m) {
    if (!m) return 0;

    // Si el usuario ingres√≥ un consumo manual, priorizamos ese
    if (m.manualConsumption !== undefined && m.manualConsumption !== null && m.manualConsumption !== '') {
        return parseDecimal(m.manualConsumption);
    }

    // Si no hay manual, procedemos con el c√°lculo autom√°tico de pacientes
    const medNombreS = (m.name || '').trim().toLowerCase();
    const medFuerzaS = String(m.strength || '').trim().toLowerCase();

    const consumoTotal = listadoPats.reduce((acc, p) => {
        const sumaPaciente = (p.prescriptions || []).reduce((subAcc, pr) => {
            if (pr.isTemporary) return subAcc;
            const medNombreP = (pr.medName || '').trim().toLowerCase();
            const medFuerzaP = String(pr.strength || '').trim().toLowerCase();

            if (medNombreP !== medNombreS || medFuerzaP !== medFuerzaS) {
                return subAcc;
            }

            const totalTabsPrescripcion = parseDecimal(pr.morningTabs) + parseDecimal(pr.afternoonTabs) + parseDecimal(pr.nightTabs);
            return subAcc + totalTabsPrescripcion;
        }, 0);
        return acc + sumaPaciente;
    }, 0);

    return Math.round(consumoTotal * 100) / 100;
}

function renderStock() {
    const tabla = document.getElementById('tabla-stock');
    tabla.innerHTML = listadoMeds.map(m => {
        const consumoComp = calcularConsumoCompPorMed(m);
        const stockNum = parseDecimal(m.stock);
        const dias = consumoComp > 0 ? Math.floor(stockNum / consumoComp) : 0;
        const hoy = new Date();
        const fechaFin = new Date(hoy);
        fechaFin.setDate(hoy.getDate() + dias);
        const fechaTxt = consumoComp > 0
            ? fechaFin.toLocaleDateString('es-AR', { day: '2-digit', month: 'long' })
            : '-';

        let colorStyle = 'background-color: #22c55e;';
        if (consumoComp > 0) {
            if (dias <= 5) colorStyle = 'background-color: #ef4444;';
            else if (dias <= 10) colorStyle = 'background-color: #eab308;';
        }

        const strengthTxt = m.strength ? String(m.strength) : '';

        return '' +
        '<tr>' +
            '<td><strong>' + (m.name || '') + '</strong></td>' +
            '<td>' + strengthTxt + '</td>' +
            '<td>' + stockNum + '</td>' +
            '<td>' + consumoComp.toFixed(2) + '</td>' +
            '<td>' +
                '<div class="dia-count" style="' + colorStyle + '">' + dias + ' d√≠as</div>' +
                '<div class="small text-muted">Hasta: ' + fechaTxt + '</div>' +
            '</td>' +
            '<td>' +
                '<button class="btn btn-outline-light btn-icon" onclick="abrirAccionesStock(\'' + m.id + '\')" aria-label="Acciones de stock para ' + (m.name || '') + '">‚Ä¢‚Ä¢‚Ä¢</button>' +
            '</td>' +
        '</tr>';
    }).join('');
}

/* Acciones stock */
function inicializarModalAccionesStock() {
    const btnEditar = document.getElementById('btn-accion-editar');
    const btnAgregar = document.getElementById('btn-accion-agregar');
    const btnDescontar = document.getElementById('btn-accion-descontar');
    const btnHistorial = document.getElementById('btn-accion-historial');
    const btnBorrar = document.getElementById('btn-accion-borrar-med'); // <--- NUEVO

    // Agregamos el efecto touch a todos
    [btnEditar, btnAgregar, btnDescontar, btnHistorial, btnBorrar].forEach(btn => {
        if(btn) { // Verificamos que exista para no romper nada
            btn.addEventListener('touchstart', () => btn.classList.add('is-active-touch'), {passive:true});
            btn.addEventListener('touchend', () => btn.classList.remove('is-active-touch'));
            btn.addEventListener('touchcancel', () => btn.classList.remove('is-active-touch'));
        }
    });

    btnEditar.addEventListener('click', function() {
        const id = medAccionesActualId;
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccionesStock'));
        if (modal) modal.hide();
        if (id) editStock(id);
    });
    btnAgregar.addEventListener('click', function() {
        const id = medAccionesActualId;
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccionesStock'));
        if (modal) modal.hide();
        if (id) addStock(id);
    });
    btnDescontar.addEventListener('click', function() {
        const id = medAccionesActualId;
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccionesStock'));
        if (modal) modal.hide();
        if (id) subStock(id);
    });
    btnHistorial.addEventListener('click', function() {
        const id = medAccionesActualId;
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccionesStock'));
        if (modal) modal.hide();
        if (id) verHistorialStock(id);
    });
    
    // --- NUEVO LISTENER ---
    if(btnBorrar) {
        btnBorrar.addEventListener('click', function() {
            const id = medAccionesActualId;
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccionesStock'));
            if (modal) modal.hide();
            if (id) eliminarMedStock(id);
        });
    }
}
function abrirAccionesStock(id) {
    medAccionesActualId = id;
    const med = listadoMeds.find(m => m.id == id);
    const title = document.getElementById('acciones-stock-title');
    title.innerText = med ? ('Acciones: ' + med.name + ' ' + (med.strength || '')) : 'Acciones de stock';
    const modal = new bootstrap.Modal(document.getElementById('modalAccionesStock'));
    modal.show();
}
async function editStock(id) {
    const med = listadoMeds.find(x => x.id == id);
    if (!med) return;

    // 1. Pedir Nombre
    const nuevoNombre = prompt('Editar nombre del medicamento:', med.name);
    if (nuevoNombre === null) return;

    // 2. Pedir Presentaci√≥n
    const nuevaStrength = prompt('Editar presentaci√≥n (ej: 2mg):', med.strength);
    if (nuevaStrength === null) return;

    // 3. Pedir Stock (manteniendo tu l√≥gica original)
    const actualStock = parseDecimal(med.stock);
    const valStock = prompt('Nuevo stock total (comprimidos):', actualStock);
    if (valStock === null) return;

    const nuevoStock = parseDecimal(valStock);
    if (Number.isNaN(nuevoStock) || nuevoStock < 0) return;

    const valConsumo = prompt('Consumo diario (deja vac√≠o para auto-calcular desde pacientes):', med.manualConsumption || '');
if (valConsumo !== null) {
    med.manualConsumption = valConsumo === '' ? null : parseDecimal(valConsumo);
}

    // Calculamos el cambio para el historial
    const cambio = nuevoStock - actualStock;

    // Actualizamos el objeto con TODO lo nuevo
    med.name = nuevoNombre.trim();
    med.strength = nuevaStrength.trim();
    med.stock = nuevoStock;
    
    med.stockHistory = med.stockHistory || [];
    med.stockHistory.push({
        date: new Date().toISOString(),
        change: cambio,
        newStock: nuevoStock,
        type: 'edit_total' // Cambiamos el tipo para saber que fue una edici√≥n completa
    });

    // Guardar en API (Enviamos todo el objeto actualizado para que se guarde nombre y strength)
    if (!modoOffline) {
        try {
            await fetch(URL_BASE + '/' + RES_MEDS + '/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(med) 
            });
        } catch (e) {
            console.error("Error al sincronizar:", e);
        }
    }

    persistirLocal();
    renderStock();
    renderPacientesPlanilla(); // IMPORTANTE: Refresca la tabla de pacientes para vincular los nombres nuevos
    actualizarDatalistMeds();   // Actualiza las sugerencias del buscador
}
async function addStock(id) {
    const med = listadoMeds.find(x => x.id == id);
    if (!med) return;
    const actual = parseDecimal(med.stock);
    const val = prompt('Cantidad a agregar (comprimidos):', '');
    if (val === null || val.trim() === '') return;
    const delta = parseDecimal(val);
    if (Number.isNaN(delta)) return;
    const nuevoStock = actual + delta;
    med.stock = nuevoStock;
    med.stockHistory = med.stockHistory || [];
    med.stockHistory.push({
        date: new Date().toISOString(),
        change: delta,
        newStock: nuevoStock,
        type: 'add'
    });
    if (!modoOffline) {
        await fetch(URL_BASE + '/' + RES_MEDS + '/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock: nuevoStock, stockHistory: med.stockHistory })
        });
    }
    persistirLocal();
    renderStock();
}
async function subStock(id) {
    const med = listadoMeds.find(x => x.id == id);
    if (!med) return;
    const actual = parseDecimal(med.stock);
    const val = prompt('Cantidad a descontar (comprimidos):', '');
    if (val === null || val.trim() === '') return;
    const delta = parseDecimal(val);
    if (Number.isNaN(delta) || delta < 0) return;
    const nuevoStock = Math.max(0, actual - delta);
    const cambio = nuevoStock - actual;
    med.stock = nuevoStock;
    med.stockHistory = med.stockHistory || [];
    med.stockHistory.push({
        date: new Date().toISOString(),
        change: cambio,
        newStock: nuevoStock,
        type: 'sub'
    });
    if (!modoOffline) {
        await fetch(URL_BASE + '/' + RES_MEDS + '/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock: nuevoStock, stockHistory: med.stockHistory })
        });
    }
    persistirLocal();
    renderStock();
}
function verHistorialStock(id) {
    const med = listadoMeds.find(x => x.id == id);
    if (!med) return;
    const hist = med.stockHistory || [];
    document.getElementById('historial-title').innerText =
        'Historial de ' + (med.name || '') + ' (' + (med.strength || '') + ')';
    const cont = document.getElementById('historial-contenido');
    if (!hist.length) {
        cont.innerHTML = '<p class="small text-muted">Sin movimientos registrados.</p>';
    } else {
        cont.innerHTML =
            '<div class="table-responsive rounded-4 overflow-hidden">' +
              '<table class="table table-sm table-dark table-bordered align-middle mb-0">' +
                '<thead>' +
                  '<tr>' +
                    '<th>Fecha</th>' +
                    '<th>Tipo</th>' +
                    '<th>Cambio</th>' +
                    '<th>Stock resultante</th>' +
                  '</tr>' +
                '</thead>' +
                '<tbody>' +
                  hist.slice().reverse().map(h => {
                    let tipo = 'Seteo';
                    if (h.type === 'add') tipo = 'Reposici√≥n';
                    else if (h.type === 'sub') tipo = 'Descuento';
                    else if (h.type === 'auto-day') tipo = 'Consumo diario autom√°tico';
                    return '' +
                      '<tr>' +
                        '<td>' + new Date(h.date).toLocaleString('es-AR') + '</td>' +
                        '<td>' + tipo + '</td>' +
                        '<td>' + (h.change > 0 ? '+' + h.change : h.change) + '</td>' +
                        '<td>' + h.newStock + '</td>' +
                      '</tr>';
                  }).join('') +
                '</tbody>' +
              '</table>' +
            '</div>';
    }
    new bootstrap.Modal('#modalHistorialStock').show();
}

/* --- NUEVA FUNCION PARA BORRAR MEDICAMENTO --- */
async function eliminarMedStock(id) {
    const med = listadoMeds.find(m => m.id == id);
    if (!med) return;

    // Confirmaci√≥n de seguridad
    if (!confirm('ATENCI√ìN: ¬øEst√°s seguro de ELIMINAR "' + med.name + '" del inventario?\n\nEsta acci√≥n no se puede deshacer y perder√°s el historial de este medicamento.')) {
        return;
    }

    // 1. Eliminar de la lista local
    listadoMeds = listadoMeds.filter(m => m.id != id);

    // 2. Eliminar de la API (si hay internet)
    if (!modoOffline) {
        try {
            await fetch(URL_BASE + '/' + RES_MEDS + '/' + id, { method: 'DELETE' });
        } catch (e) {
            console.error('Error borrando en API:', e);
            alert('Se borr√≥ localmente, pero hubo error con la API.');
        }
    }

    // 3. Guardar y actualizar vista
    persistirLocal();
    renderStock();
    actualizarDatalistMeds(); // Actualizamos las sugerencias del buscador
}

/* Carrito */
function obtenerItemsCarrito() {
    const items = [];
    listadoMeds.forEach(m => {
        const consumo = calcularConsumoCompPorMed(m);
        if (consumo <= 0) return;
        const stock = parseDecimal(m.stock);
        const dias = stock / consumo;
        if (dias < DIAS_MINIMOS) {
            const falta = Math.max(0, Math.ceil(DIAS_OBJETIVO * consumo - stock));
            items.push({
                nombre: m.name,
                strength: m.strength || '',
                falta: falta
            });
        }
    });
    return items;
}
function abrirCarrito() {
    const lista = document.getElementById('carrito-lista');
    const items = obtenerItemsCarrito();
    if (!items.length) {
        lista.innerHTML = '<li class="text-muted">No hay medicamentos por debajo de 5 d√≠as.</li>';
    } else {
        lista.innerHTML = items.map(it =>
            '<li>' + it.nombre + (it.strength ? ' ' + it.strength : '') + ' (' + it.falta + ')</li>'
        ).join('');
    }
    document.getElementById('carrito-msg').innerText = '';
    new bootstrap.Modal('#modalCarrito').show();
}
async function copiarCarrito() {
    const items = obtenerItemsCarrito();
    if (!items.length) {
        document.getElementById('carrito-msg').innerText = 'No hay nada para copiar.';
        return;
    }
    const texto = items.map(it =>
        it.nombre + (it.strength ? ' ' + it.strength : '') + ' (' + it.falta + ')'
    ).join(', ');
    try {
        if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(texto);
            document.getElementById('carrito-msg').innerText = 'Copiado al portapapeles.';
        } else {
            document.getElementById('carrito-msg').innerText = 'Clipboard no disponible en este navegador.';
        }
    } catch (e) {
        document.getElementById('carrito-msg').innerText = 'No se pudo copiar.';
    }
}

/* Paciente: abrir / editar */
function abrirModal() {
    document.getElementById('modalTitle').innerText = 'Nuevo Registro';
    document.getElementById('edit-id').value = '';
    document.getElementById('in-nombre').value = '';
    document.getElementById('in-dni').value = '';
    document.getElementById('in-alergias').value = '';
    document.getElementById('lista-prescripciones').innerHTML = '';
    nuevaFila();
    new bootstrap.Modal('#modalPaciente').show();
}
function abrirEdicion(id) {
    const p = listadoPats.find(x => x.id == id);
    if (!p) return;
    document.getElementById('modalTitle').innerText = 'Editar paciente';
    document.getElementById('edit-id').value = p.id;
    document.getElementById('in-nombre').value = p.name || '';
    document.getElementById('in-dni').value = p.dni || '';
    document.getElementById('in-alergias').value = p.allergies || '';

    const cont = document.getElementById('lista-prescripciones');
    cont.innerHTML = '';
(p.prescriptions || []).forEach(pr => {
        nuevaFila(
            pr.medName || '',
            pr.dosisPorComprimidoMg || '',
            pr.strength || '',
            pr.morningTabs || '',
            pr.afternoonTabs || '',
            pr.nightTabs || '',
            !!pr.isTemporary,
            pr.freqType || 'diario', // Nuevo
            pr.freqValue,           // Nuevo
            pr.startDate            // Nuevo (usamos startDate como lastTaken ref)
        );
    });
    if (!(p.prescriptions || []).length) nuevaFila();
    new bootstrap.Modal('#modalPaciente').show();
}

function nuevaFila(
    n = '', dosisComp = '', strength = '',
    mTabs = '', aTabs = '', nTabs = '', isTemp = false,
    freqType = 'diario', freqValue = '', lastTaken = '' // Nuevos par√°metros
) {
    const cont = document.getElementById('lista-prescripciones');
    const idx = Date.now() + Math.random().toString(16).slice(2); // ID √∫nico para colapsables
    const fila = document.createElement('div');
    fila.className = 'border rounded-3 p-2 mb-2 position-relative';
    
    // L√≥gica para mostrar/ocultar inputs seg√∫n tipo
    const displayDays = freqType === 'semanal' ? 'block' : 'none';
    const displayInt = freqType === 'intervalo' ? 'block' : 'none';

    // Parsear freqValue si viene guardado
    let checks = [false,false,false,false,false,false,false]; // D L M M J V S
    if(freqType === 'semanal' && Array.isArray(freqValue)) {
        freqValue.forEach(d => checks[d] = true);
    }
    const intervalVal = (freqType === 'intervalo') ? freqValue : 2;

    fila.innerHTML = `
    <div class="row g-2 align-items-end">
        <div class="col-md-4 col-12">
            <label class="form-label small text-secondary">Droga</label>
            <input type="text" class="form-control in-medName fixed" list="lista-meds-sugeridos" value="${n}" placeholder="Nombre medicamento">
        </div>
        <div class="col-md-3 col-6">
            <label class="form-label small text-secondary">Presentaci√≥n</label>
            <input type="text" class="form-control in-strength fixed" value="${strength}" placeholder="Ej: 500mg">
        </div>
        <div class="col-md-3 col-6">
            <label class="form-label small text-secondary">Dosis (mg/comp.)</label>
            <input type="number" step="any" class="form-control in-dosisComp fixed" value="${dosisComp}">
        </div>
    </div>
    
    <div class="row g-2 mt-1 align-items-center justify-content-center">
        <div class="col-3 col-md-2">
            <label class="form-label small text-center w-100">Ma√±ana</label>
            <input type="number" step="0.01" class="form-control text-center in-mTabs" value="${mTabs}" placeholder="0">
        </div>
        <div class="col-3 col-md-2">
            <label class="form-label small text-center w-100">Tarde</label>
            <input type="number" step="0.01" class="form-control text-center in-aTabs" value="${aTabs}" placeholder="0">
        </div>
        <div class="col-3 col-md-2">
            <label class="form-label small text-center w-100">Noche</label>
            <input type="number" step="0.01" class="form-control text-center in-nTabs" value="${nTabs}" placeholder="0">
        </div>
        <div class="col-4 col-md-8 d-flex align-items-center justify-content-center gap-2 mt-4">
             <div class="form-check">
                <input class="form-check-input in-temp" type="checkbox" ${isTemp ? 'checked' : ''} id="temp-${idx}">
                <label class="form-check-label small" for="temp-${idx}">Temp</label>
            </div>
            <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#config-${idx}">
                ‚öôÔ∏è Frecuencia
            </button>
        </div>
    </div>
            <div class="col-md-2 col-12 text-end">
             <button type="button" class="btn btn-sm btn-outline-danger mt-4" onclick="eliminarFila(this)">üóë</button>
        </div>

    <div class="collapse ${freqType !== 'diario' ? 'show' : ''} mt-2" id="config-${idx}">
        <div class="freq-controls">
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="small text-muted">Tipo de Frecuencia</label>
                    <select class="form-select form-select-sm in-freqType" onchange="toggleFreqOptions(this)">
                        <option value="diario" ${freqType === 'diario' ? 'selected' : ''}>Diario (Todos los d√≠as)</option>
                        <option value="semanal" ${freqType === 'semanal' ? 'selected' : ''}>D√≠as de la semana</option>
                        <option value="intervalo" ${freqType === 'intervalo' ? 'selected' : ''}>Intervalo (D√≠a por medio, etc)</option>
                    </select>
                </div>
                
                <div class="col-md-8 freq-opt-semanal" style="display: ${displayDays}">
                    <label class="small text-muted d-block">Seleccionar d√≠as:</label>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="checkbox" class="btn-check day-chk" value="1" id="d1-${idx}" ${checks[1]?'checked':''}> <label class="btn btn-outline-secondary" for="d1-${idx}">Lu</label>
                        <input type="checkbox" class="btn-check day-chk" value="2" id="d2-${idx}" ${checks[2]?'checked':''}> <label class="btn btn-outline-secondary" for="d2-${idx}">Ma</label>
                        <input type="checkbox" class="btn-check day-chk" value="3" id="d3-${idx}" ${checks[3]?'checked':''}> <label class="btn btn-outline-secondary" for="d3-${idx}">Mi</label>
                        <input type="checkbox" class="btn-check day-chk" value="4" id="d4-${idx}" ${checks[4]?'checked':''}> <label class="btn btn-outline-secondary" for="d4-${idx}">Ju</label>
                        <input type="checkbox" class="btn-check day-chk" value="5" id="d5-${idx}" ${checks[5]?'checked':''}> <label class="btn btn-outline-secondary" for="d5-${idx}">Vi</label>
                        <input type="checkbox" class="btn-check day-chk" value="6" id="d6-${idx}" ${checks[6]?'checked':''}> <label class="btn btn-outline-secondary" for="d6-${idx}">Sa</label>
                        <input type="checkbox" class="btn-check day-chk" value="0" id="d0-${idx}" ${checks[0]?'checked':''}> <label class="btn btn-outline-secondary" for="d0-${idx}">Do</label>
                    </div>
                </div>

                <div class="col-md-8 freq-opt-intervalo" style="display: ${displayInt}">
                    <div class="d-flex gap-2 align-items-end">
                        <div class="flex-grow-1">
                            <label class="small text-muted">Cada cuantos d√≠as:</label>
                            <input type="number" min="2" class="form-control form-control-sm in-intervalVal" value="${intervalVal}" placeholder="Ej: 2 (D√≠a por medio)">
                        </div>
                        <div class="flex-grow-1">
                            <label class="small text-muted">Fecha inicio ref:</label>
                            <input type="date" class="form-control form-control-sm in-startDate" value="${lastTaken ? lastTaken.split('T')[0] : new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                    <div class="small text-warning mt-1" style="font-size: 0.7rem;">* "2" significa toma un d√≠a s√≠, un d√≠a no.</div>
                </div>
            </div>
        </div>
    </div>
    `;
    cont.appendChild(fila);
}

// Helper para mostrar/ocultar opciones en el modal
function toggleFreqOptions(select) {
    const parent = select.closest('.freq-controls');
    const val = select.value;
    parent.querySelector('.freq-opt-semanal').style.display = (val === 'semanal') ? 'block' : 'none';
    parent.querySelector('.freq-opt-intervalo').style.display = (val === 'intervalo') ? 'block' : 'none';
}
function eliminarFila(btn) {
    const fila = btn.closest('.border');
    if (fila && fila.parentNode) fila.parentNode.removeChild(fila);
}

/* Guardar paciente con spinner y dosis diaria correcta */
async function guardarPaciente() {
    const btn = document.getElementById('btn-guardar-paciente');
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Guardando‚Ä¶';

    try {
        const id = document.getElementById('edit-id').value || null;
        const nombre = document.getElementById('in-nombre').value.trim();
        const dni = document.getElementById('in-dni').value.trim();
        const alergias = document.getElementById('in-alergias').value.trim();

        if (!nombre) {
            alert('El nombre es obligatorio');
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
            return;
        }

        const pres = [];
        const medsNuevos = [];

document.querySelectorAll('#lista-prescripciones > .border').forEach(div => {
            const medName = div.querySelector('.in-medName').value.trim();
            const strength = div.querySelector('.in-strength').value.trim();
            const dosisComp = parseDecimal(div.querySelector('.in-dosisComp').value);
            const mTabs = parseDecimal(div.querySelector('.in-mTabs').value);
            const aTabs = parseDecimal(div.querySelector('.in-aTabs').value);
            const nTabs = parseDecimal(div.querySelector('.in-nTabs').value);
            const isTemp = div.querySelector('.in-temp').checked;

            // --- NUEVO: CAPTURA DE FRECUENCIA ---
            const freqType = div.querySelector('.in-freqType').value;
            let freqValue = null;
            let startDate = null;

            if (freqType === 'semanal') {
                freqValue = [];
                div.querySelectorAll('.day-chk:checked').forEach(chk => {
                    freqValue.push(parseInt(chk.value));
                });
            } else if (freqType === 'intervalo') {
                freqValue = parseInt(div.querySelector('.in-intervalVal').value) || 2;
                startDate = div.querySelector('.in-startDate').value; // Guardamos fecha referencia
            }
            // -------------------------------------

            if (!medName) return;

            const totalTabsDia = Math.round((mTabs + aTabs + nTabs) * 100) / 100;
            const dailyDosageMg = dosisComp * totalTabsDia;

            pres.push({
                medName, strength, dosisPorComprimidoMg: dosisComp,
                dailyDosageMg, morningTabs: mTabs, afternoonTabs: aTabs, nightTabs: nTabs,
                isTemporary: isTemp,
                // Guardamos nuevos campos
                freqType, freqValue, startDate
            });

            medsNuevos.push({ name: medName, strength: strength });
        });

        const payload = {
            name: nombre,
            dni,
            allergies: alergias,
            prescriptions: pres,
            lastUpdated: new Date().toISOString()
        };

        if (id) {
            const idx = listadoPats.findIndex(p => p.id == id);
            if (idx !== -1) {
                listadoPats[idx] = { ...listadoPats[idx], ...payload };
                if (!modoOffline) {
                    await fetch(URL_BASE + '/' + RES_PATS + '/' + id, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(listadoPats[idx])
                    });
                }
            }
        } else {
            const nuevo = { ...payload };
            if (!modoOffline) {
                const resp = await fetch(URL_BASE + '/' + RES_PATS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevo)
                });
                const creado = await resp.json();
                nuevo.id = creado.id;
            } else {
                nuevo.id = 'local-' + Date.now();
            }
            listadoPats.push(nuevo);
        }

        await asegurarMedsEnStock(medsNuevos);
        persistirLocal();
        renderPacientesPlanilla();
        renderStock();
        actualizarDatalistMeds();

        const modal = bootstrap.Modal.getInstance(document.getElementById('modalPaciente'));
        if (modal) modal.hide();
    } catch (e) {
        alert('Hubo un problema al guardar.');
        console.error(e);
    } finally {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    }
}

/* Crear meds en stock si no existen */
async function asegurarMedsEnStock(lista) {
    for (const item of lista) {
        const name = item.name;
        const strength = item.strength || '';
        const yaExiste = listadoMeds.some(m =>
            (m.name || '').toLowerCase() === name.toLowerCase() &&
            String(m.strength || '').toLowerCase() === strength.toLowerCase()
        );
        if (yaExiste) continue;

        const nuevoMed = {
            name,
            strength,
            mgPerUnit: null,
            stock: 0,
            stockHistory: []
        };

        if (!modoOffline) {
            const resp = await fetch(URL_BASE + '/' + RES_MEDS, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nuevoMed)
            });
            const creado = await resp.json();
            nuevoMed.id = creado.id;
        } else {
            nuevoMed.id = 'auto-med-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        }

        listadoMeds.push(nuevoMed);
    }
}

/* Eliminar / detalle paciente */
async function eliminarP(id) {
    if (!confirm('¬øSeguro que quer√©s borrar este paciente?')) return;
    listadoPats = listadoPats.filter(p => p.id != id);
    if (!modoOffline) {
        await fetch(URL_BASE + '/' + RES_PATS + '/' + id, { method: 'DELETE' });
    }
    persistirLocal();
    renderPacientesPlanilla();
    renderStock();
}
function verDetallePaciente(id) {
    const p = listadoPats.find(x => x.id == id);
    if (!p) return;
    document.getElementById('detalle-title').innerText = 'Detalle del paciente';
    document.getElementById('detalle-nombre').innerText = p.name || '';
    document.getElementById('detalle-dni').innerText = p.dni || '';
    document.getElementById('detalle-alergias').innerText =
        (p.allergies && p.allergies.trim()) ? p.allergies : 'Sin datos';
    document.getElementById('detalle-last').innerText =
        p.lastUpdated ? new Date(p.lastUpdated).toLocaleString('es-AR') : 'Sin registro';

    const cont = document.getElementById('detalle-prescripciones');
    if (!(p.prescriptions || []).length) {
        cont.innerHTML = '<p class="small text-muted">Sin prescripciones.</p>';
    } else {
        cont.innerHTML = `
            <div class="table-responsive rounded-4">
                <table class="table table-dark table-sm table-bordered mb-0">
                    <thead>
                        <tr>
                            <th>Medicaci√≥n</th>
                            <th>Dosis total (mg/d√≠a)</th>
                            <th>Ma√±ana</th>
                            <th>Tarde</th>
                            <th>Noche</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${p.prescriptions.map(pr => `
                            <tr class="${pr.isTemporary ? 'temp-med-row temp-med-border' : ''}">
                                <td>${pr.medName || ''} ${pr.strength ? '(' + pr.strength + ')' : ''} ${pr.isTemporary ? 'TEMP' : ''}</td>
                                <td>${parseDecimal(pr.dailyDosageMg)}</td>
                                <td>${parseDecimal(pr.morningTabs)}</td>
                                <td>${parseDecimal(pr.afternoonTabs)}</td>
                                <td>${parseDecimal(pr.nightTabs)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    new bootstrap.Modal('#modalDetallePaciente').show();
}

/* Nuevo medicamento en stock */
function abrirModalNuevoMed() {
    document.getElementById('med-nombre').value = '';
    document.getElementById('med-strength').value = '';
    document.getElementById('med-stock').value = '';
    new bootstrap.Modal('#modalNuevoMed').show();
}
async function guardarNuevoMed() {
    const name = document.getElementById('med-nombre').value.trim();
    const strength = document.getElementById('med-strength').value.trim();
    const stock = parseDecimal(document.getElementById('med-stock').value);
    const manualCons = document.getElementById('med-manual-consumption').value; // Nuevo

    if (!name) {
        alert('El nombre es obligatorio');
        return;
    }

    const nuevo = {
        name,
        strength,
        stock: Number.isNaN(stock) ? 0 : stock,
        manualConsumption: manualCons !== '' ? parseDecimal(manualCons) : null, // Nuevo
        stockHistory: []
    };
    // ... resto del c√≥digo de la funci√≥n (fetch, push, persistir) ...

    if (!modoOffline) {
        const resp = await fetch(URL_BASE + '/' + RES_MEDS, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(nuevo)
        });
        const creado = await resp.json();
        nuevo.id = creado.id;
    } else {
        nuevo.id = 'local-med-' + Date.now();
    }

    listadoMeds.push(nuevo);
    persistirLocal();
    actualizarDatalistMeds();
    renderStock();

    const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoMed'));
    if (modal) modal.hide();
}

/* Datalist sugerencias de meds */
function actualizarDatalistMeds() {
    const dl = document.getElementById('lista-meds-sugeridos');
    if (!dl) return;
    const usados = new Set();
    dl.innerHTML = listadoMeds.map(m => {
        const nombre = m.name || '';
        const strength = m.strength || '';
        const label = strength ? (nombre + ' ' + strength) : nombre;
        if (!label || usados.has(label.toLowerCase())) return '';
        usados.add(label.toLowerCase());
        return '<option value="' + label + '"></option>';
    }).join('');
}

// Pega esto en la consola de F12 para debuguear
listadoMeds.forEach(m => {
   const consumo = calcularConsumoCompPorMed(m);
   console.log(`Medicamento: ${m.name}, Consumo calculado: ${consumo}`);
});

// --- FUNCI√ìN PARA DESCARGAR TODA LA DATA EN JSON ---
function descargarDatosJSON() {
    // Creamos un objeto que contenga todo: pacientes y stock
    const dataAConservar = {
        pacientes: listadoPats,
        stock: listadoMeds,
        fecha_exportacion: new Date().toISOString()
    };

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataAConservar, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "backup_stock_pacientes_" + obtenerFechaSimple() + ".json");
    document.body.appendChild(downloadAnchorNode); // Requerido para Firefox
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

// Funci√≥n auxiliar para el nombre del archivo
function obtenerFechaSimple() {
    const d = new Date();
    return d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
}

// --- DESCARGAR PACIENTES EN CSV (PARA EXCEL) ---
function descargarPacientesCSV() {
    if (listadoPats.length === 0) {
        alert("No hay pacientes para exportar.");
        return;
    }

    // Cabeceras de las columnas
    let csvContent = "Nombre,DNI,Alergias,Medicamentos (Resumen)\n";

    listadoPats.forEach(p => {
        // Creamos un resumen de sus medicamentos para que quepan en una sola celda
        const resumenMeds = (p.prescriptions || [])
            .map(pr => `${pr.medName} (${pr.strength})`)
            .join(" - ");

        // Limpiamos comas internas para no romper las columnas del CSV
        const nombre = (p.name || "").replace(/,/g, "");
        const dni = (p.dni || "").replace(/,/g, "");
        const alergias = (p.allergies || "").replace(/,/g, "");

        csvContent += `"${nombre}","${dni}","${alergias}","${resumenMeds}"\n`;
    });

    // El "BOM" (\uFEFF) sirve para que Excel reconozca tildes y e√±es correctamente
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "lista_pacientes_" + obtenerFechaSimple() + ".csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- DESCARGAR BACKUP COMPLETO EN JSON ---
function descargarDatosJSON() {
    const data = {
        pacientes: listadoPats,
        stock: listadoMeds,
        exportado: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "backup_sistema_" + obtenerFechaSimple() + ".json";
    link.click();
}

// Funci√≥n auxiliar para el nombre del archivo
function obtenerFechaSimple() {
    const d = new Date();
    return d.toISOString().split('T')[0]; // Devuelve YYYY-MM-DD
}

function mostrarAyuda() {
    const modal = new bootstrap.Modal(document.getElementById('modalAyuda'));
    modal.show();
}


function abrirSimuladorTiempo() {
    // Ponemos por defecto la fecha de ma√±ana en el input
    const ma√±ana = new Date();
    ma√±ana.setDate(ma√±ana.getDate() + 1);
    document.getElementById('simular-fecha-input').value = ma√±ana.toISOString().substring(0,10);
    new bootstrap.Modal('#modalSimulador').show();
}

async function aplicarFechaSimulada() {
    const nuevaFechaStr = document.getElementById('simular-fecha-input').value;
    if (!nuevaFechaStr) return;

    const ultima = localStorage.getItem(DAILY_KEY);
    if (!ultima) {
        alert("Primero debe haber un registro de hoy. Recarga la p√°gina normalmente.");
        return;
    }

    const dUltima = new Date(ultima + 'T00:00:00');
    const dSimulada = new Date(nuevaFechaStr + 'T00:00:00');

    const diffMs = dSimulada.getTime() - dUltima.getTime();
    const diasPasados = Math.floor(diffMs / (1000*60*60*24));

    if (diasPasados <= 0) {
        alert("Elige una fecha posterior a la √∫ltima actualizaci√≥n (" + ultima + ")");
        return;
    }

    if (confirm(`¬øSimular el paso de ${diasPasados} d√≠a(s)? Se descontar√° stock de todos los medicamentos.`)) {
        // Ejecutamos la l√≥gica de descuento
        listadoMeds.forEach(m => {
            const consumo = calcularConsumoCompPorMed(m);
            if (consumo <= 0) return;
            
            const stockActual = parseDecimal(m.stock);
            const descuento = consumo * diasPasados;
            const nuevoStock = Math.max(0, stockActual - descuento);
            const cambio = nuevoStock - stockActual;

            if (cambio !== 0) {
                m.stock = nuevoStock;
                m.stockHistory = m.stockHistory || [];
                m.stockHistory.push({
                    date: new Date().toISOString(),
                    change: cambio,
                    newStock: nuevoStock,
                    type: 'auto-day'
                });
            }
        });

        // Actualizamos la fecha de "√∫ltima vez" a la fecha simulada
        localStorage.setItem(DAILY_KEY, nuevaFechaStr);
        persistirLocal();
        renderizar();
        
        bootstrap.Modal.getInstance(document.getElementById('modalSimulador')).hide();
        alert("Simulaci√≥n completada. Se descont√≥ el consumo de " + diasPasados + " d√≠as.");
    }
}
//iniciar onload
function procesarDescuentoPorTiempo() {
    const hoy = new Date();
    const hoyStr = hoy.toISOString().split('T')[0];
    const ultimaCarga = localStorage.getItem('ultima_conexion_stock');

    // Si ya se proces√≥ hoy, no hacer nada
    if (ultimaCarga === hoyStr) return;

    let meds = JSON.parse(localStorage.getItem('local_meds')) || [];
    let pats = JSON.parse(localStorage.getItem('local_pats')) || [];
    
    if (meds.length === 0 || !ultimaCarga) {
        localStorage.setItem('ultima_conexion_stock', hoyStr);
        return;
    }

    const fechaAnterior = new Date(ultimaCarga);
    const diffTiempo = hoy - fechaAnterior;
    const diasPasados = Math.floor(diffTiempo / (1000 * 60 * 60 * 24));

    if (diasPasados > 0) {
        let huboCambios = false;

        meds = meds.map(m => {
            // Calcular consumo diario igual que lo hace tu app
            let consumoDiario = 0;
            if (m.manualConsumption) {
                consumoDiario = parseFloat(m.manualConsumption);
            } else {
                pats.forEach(p => {
                    (p.prescriptions || []).forEach(pr => {
                        if (pr.medName === m.name && pr.strength === m.strength && !pr.isTemporary) {
                            consumoDiario += (parseFloat(pr.morningTabs) || 0) + 
                                             (parseFloat(pr.afternoonTabs) || 0) + 
                                             (parseFloat(pr.nightTabs) || 0);
                        }
                    });
                });
            }

            if (consumoDiario > 0) {
                const totalADescontar = consumoDiario * diasPasados;
                m.stock = Math.max(0, (parseFloat(m.stock) || 0) - totalADescontar);
                huboCambios = true;
                
                // Registrar en historial para que veas que funcion√≥
                if(!m.stockHistory) m.stockHistory = [];
                m.stockHistory.push({
                    date: new Date().toISOString(),
                    change: -totalADescontar,
                    newStock: m.stock,
                    type: 'auto-descuento-diario'
                });
            }
            return m;
        });

        if (huboCambios) {
            localStorage.setItem('local_meds', JSON.stringify(meds));
        }
    }
    
    localStorage.setItem('ultima_conexion_stock', hoyStr);
}

// REEMPLAZO DE TU LISTENER ORIGINAL
window.addEventListener('load', () => {
    // 1. Ejecutar el descuento autom√°tico antes que nada
    procesarDescuentoPorTiempo();

    // 2. Tu l√≥gica original de login
    if (localStorage.getItem('auth_stock_ba') === 'true' || 
        sessionStorage.getItem('auth_stock_ba') === 'true') {
        document.getElementById('login-overlay').style.display = 'none';
        iniciar();
    }
});


        let contadorClicsTest = 0;
const areaSecreta = document.getElementById('area-clic-secreta');
const contenedorTest = document.getElementById('btn-test-container');

if (areaSecreta) {
    areaSecreta.addEventListener('click', () => {
        contadorClicsTest++;
        
        // Si llega a 5 clics, muestra el bot√≥n
        if (contadorClicsTest === 5) {
            contenedorTest.style.display = 'block';
            // Opcional: un peque√±o aviso visual o log
            console.log("Modo Test activado");
        }
    });
}

// if ('serviceWorker' in navigator) {
//   navigator.serviceWorker.register('./sw.js')
//     .catch(err => console.log("Error al registrar SW", err));
// }

</script>
<!-- <div class="modal fade" id="modalAyuda" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">‚ùì Gu√≠a de Uso y Control de Dosis</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 class="text-warning mb-3">üìã C√≥mo completar las dosis (Ma√±ana, Tarde, Noche)</h6>
        <p>Para que el stock se descuente correctamente, utiliza <strong>puntos (.)</strong> para los decimales. Aqu√≠ tienes la equivalencia de comprimidos:</p>
        
        <div class="table-responsive">
          <table class="table table-dark table-bordered text-center">
            <thead>
              <tr class="table-secondary text-dark">
                <th>Fracci√≥n</th>
                <th>N√∫mero a ingresar</th>
                <th>Ejemplo</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1/4 Comprimido</td>
                <td><code class="fs-5 text-info">0.25</code></td>
                <td>Dosis m√≠nima o ajuste.</td>
              </tr>
              <tr>
                <td>1/2 Comprimido</td>
                <td><code class="fs-5 text-info">0.5</code></td>
                <td>Media pastilla.</td>
              </tr>
              <tr>
                <td>3/4 Comprimido</td>
                <td><code class="fs-5 text-info">0.75</code></td>
                <td>Media pastilla + un cuarto.</td>
              </tr>
              <tr>
                <td>1 Comprimido</td>
                <td><code class="fs-5 text-info">1</code></td>
                <td>Pastilla completa.</td>
              </tr>
              <tr>
                <td>1 y 1/2 Comp.</td>
                <td><code class="fs-5 text-info">1.5</code></td>
                <td>Pastilla y media.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <hr class="border-secondary">

        <h6 class="text-warning mb-3">‚öôÔ∏è ¬øC√≥mo funciona la aplicaci√≥n?</h6>
        <ul class="list-group list-group-flush bg-dark">
          <li class="list-group-item bg-dark text-light border-secondary">
            <strong>1. Stock F√≠sico:</strong> En la secci√≥n Inventario, carga la cantidad total de pastillas reales que tienes en la caja.
          </li>
          <li class="list-group-item bg-dark text-light border-secondary">
            <strong>2. Pacientes:</strong> Al crear un paciente, aseg√∫rate de que el nombre del medicamento coincida <u>exactamente</u> con el del Inventario.
          </li>
          <li class="list-group-item bg-dark text-light border-secondary">
            <strong>3. Descuento Autom√°tico:</strong> El sistema suma las dosis diarias de todos los pacientes y las resta del stock autom√°ticamente cada d√≠a que abres la app.
          </li>
          <li class="list-group-item bg-dark text-light border-secondary">
            <strong>4. Alertas:</strong> 
            <span class="badge bg-danger">Rojo</span>: Menos de 5 d√≠as de stock. <br>
            <span class="badge bg-warning text-dark">Amarillo</span>: Menos de 10 d√≠as de stock.
          </li>
        </ul>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalSimulador" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Simulador de Fecha</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="small mb-2">Simular que hoy es:</label>
        <input type="date" id="simular-fecha-input" class="form-control mb-3">
        <p class="text-muted" style="font-size: 0.7rem;">
            Al cambiar la fecha, el sistema detectar√° los d√≠as transcurridos desde la √∫ltima vez y descontar√° el stock proporcionalmente.
        </p>
        <button class="btn btn-danger w-100" onclick="aplicarFechaSimulada()">Aplicar Salto Temporal</button>
      </div>
    </div>
  </div>
</div> -->

<!-- <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      // Registramos un Service Worker vac√≠o para eliminar errores de consola
      const swCode = "self.addEventListener('fetch', function(event) {});";
      const blob = new Blob([swCode], {type: 'text/javascript'});
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).catch(err => console.log('SW error omitido'));
    });
  }
</script> -->

</body>
</html>
