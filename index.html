<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Control Stock - Buenos Aires</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="manifest" href='data:application/manifest+json,{"name":"Control Stock Buenos Aires","short_name":"Stock BA","start_url":"./","display":"standalone","background_color":"#111827","theme_color":"#111827"}'>
    <meta name="theme-color" content="#111827">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            font-size: 17px;
            line-height: 1.5;
        }

        body {
            background-color: #121212;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: #f5f5f5;
            padding-bottom: 70px;
        }

        button:focus-visible,
        a:focus-visible {
            outline: 3px solid #facc15;
            outline-offset: 2px;
        }

        .navbar {
            background: #1f2933;
        }

        .nav-pills .nav-link {
            background-color: #111827;
            color: #e5e7eb;
            font-size: 0.95rem;
        }

        .nav-pills .nav-link.active {
            background-color: #2563eb;
        }

        .card {
            background: #1e1e1e;
            color: #f5f5f5;
            border-radius: 1rem;
            border: 2px solid #374151;
        }

        .paciente-card {
            margin-bottom: 1.5rem;
            border-radius: 1rem;
        }

        .planilla-inner-table {
            font-size: 0.9rem;
        }

        .planilla-inner-table th,
        .planilla-inner-table td {
            border-width: 2px !important;
        }

        .table-responsive {
            font-size: 0.9rem;
        }

        .stock-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            h3 {
                font-size: 1.1rem;
            }
            .navbar-brand {
                font-size: 1rem;
            }
            #tabla-stock-table {
                min-width: 650px;
            }
            #tabla-stock-table th,
            #tabla-stock-table td {
                white-space: nowrap;
            }
        }

        .dia-count {
            font-size: 0.95rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.6rem;
            color: #111827;
            display: inline-block;
            border: 1px solid #0f172a;
            font-weight: 600;
        }

        .modal-content {
            background-color: #1e1e1e;
            color: #f5f5f5;
            border-radius: 1rem;
            border-width: 2px;
        }

        .form-control {
            background-color: #111827;
            border-color: #4b5563;
            color: #f9fafb;
            font-size: 0.9rem;
        }

        .form-control:focus {
            background-color: #111827;
            color: #f9fafb;
            border-color: #facc15;
            box-shadow: 0 0 0 0.15rem rgba(250, 204, 21, 0.35);
        }

        .badge-turno {
            border-radius: 999px;
            padding: 0.15rem 0.6rem;
            font-size: 0.8rem;
        }

        .btn {
            font-size: 0.95rem;
            border-radius: 999px;
        }

        .btn-group-sm .btn {
            padding-inline: 0.6rem;
        }

        .temp-med-row {
            background-color: rgba(250, 204, 21, 0.18);
        }

        .temp-med-border {
            border-color: #eab308 !important;
        }

        .avatar-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #f9fafb;
            margin-right: 0.75rem;
            flex-shrink: 0;
            border: 2px solid #4b5563;
        }

        .bottom-nav {
            display: none;
        }

        @media (max-width: 768px) {
            .bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: #020617;
                border-top: 1px solid #374151;
                z-index: 1030;
            }
            .bottom-nav .nav-link {
                flex: 1;
                text-align: center;
                padding: 0.7rem 0.2rem;
                font-size: 0.85rem;
                color: #9ca3af;
                border-radius: 0;
            }
            .bottom-nav .nav-link span {
                display: block;
                font-size: 1.1rem;
            }
            .bottom-nav .nav-link.active {
                color: #f9fafb;
                background-color: #111827;
            }
        }

        @media print {
            @page {
                size: A4 portrait;
                margin: 1cm;
            }
            body {
                background: #ffffff;
                color: #000000;
                padding-bottom: 0;
            }
            .navbar,
            .nav,
            .btn,
            #modalPaciente,
            #modalDetallePaciente,
            #modalHistorialStock,
            #modalCarrito,
            #modalAccionesStock,
            .bottom-nav {
                display: none !important;
            }
            .card.paciente-card {
                break-inside: avoid;
                box-shadow: none !important;
                border-color: #000 !important;
            }
            #tab-stock {
                display: none !important;
            }
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
        }

        .btn-icon:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }

        .btn-icon:active {
            background-color: #1e40af;
            border-color: #1e40af;
        }

        .acciones-stock-btn {
            border-radius: 0.9rem;
            border-width: 2px;
            font-size: 1rem;
            padding: 0.85rem 1rem;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .acciones-stock-btn span.icono {
            font-size: 1.2rem;
        }

        .acciones-stock-btn:hover {
            filter: brightness(1.08);
        }

        .acciones-stock-btn.is-active-touch {
            outline: 3px solid #facc15;
            outline-offset: 1px;
        }

        @media (max-width: 768px) {
            .acciones-stock-btn {
                font-size: 1.05rem;
                padding: 1rem 1.1rem;
            }
        }

        .btn-accion-editar {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
            color: #f9fafb;
        }

        .btn-accion-agregar {
            background-color: #15803d;
            border-color: #15803d;
            color: #f9fafb;
        }

        .btn-accion-descontar {
            background-color: #b91c1c;
            border-color: #b91c1c;
            color: #f9fafb;
        }

        .btn-accion-historial {
            background-color: #0f172a;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        .btn-accion-historial:hover {
            background-color: #111827;
        }

        /* Botones paciente accesibles */
        .btn-accion-paciente {
            font-weight: 500;
            border-radius: 999px;
        }
        .btn-accion-paciente:focus-visible {
            outline: 3px solid #facc15;
            outline-offset: 2px;
        }
        @media (hover: none) {
            .btn-accion-paciente:active {
                transform: scale(0.97);
                box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.4);
            }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4 p-3">
    <div class="container d-flex justify-content-between">
        <span class="navbar-brand">üè• Control Stock - Buenos Aires</span>
        <div id="status-indicator" class="text-white small">Cargando...</div>
    </div>
</nav>

<div class="container">
    <ul class="nav nav-pills mb-4 d-none d-md-flex">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-pats" id="tab-btn-pats-top">üë• Pacientes</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-stock" id="tab-btn-stock-top">üì¶ Stock e Inventario</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-pats">
            <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
                <h3>Pacientes</h3>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-primary" onclick="abrirModal()">+ Registrar Paciente</button>
                    <button class="btn btn-outline-light" onclick="imprimirPlanilla()">üñ® Imprimir A4</button>
                </div>
            </div>
            <div id="lista-pacientes-planilla"></div>
        </div>

        <div class="tab-pane fade" id="tab-stock">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <h3>Estado de Suministros</h3>
                <div>
                    <button class="btn btn-warning btn-sm" onclick="abrirCarrito()">üõí Ver carrito</button>
                </div>
            </div>
            <div class="card p-3 shadow-sm rounded-4">
                <div class="table-responsive rounded-4 stock-wrapper">
                    <table class="table align-middle mt-1 table-dark table-sm table-bordered mb-0" id="tabla-stock-table">
                        <thead>
                            <tr>
                                <th>Droga</th>
                                <th>Presentaci√≥n</th>
                                <th>Stock</th>
                                <th>Consumo/d√≠a</th>
                                <th>D√≠as / Fecha fin</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-stock"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<nav class="bottom-nav nav justify-content-around">
    <button class="nav-link active" id="tab-btn-pats-bottom" onclick="activarTab('tab-pats')">
        <span>üë•</span>
        Pacientes
    </button>
    <button class="nav-link" id="tab-btn-stock-bottom" onclick="activarTab('tab-stock')">
        <span>üì¶</span>
        Stock
    </button>
</nav>

<!-- MODAL ACCIONES STOCK -->
<div class="modal fade" id="modalAccionesStock" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="acciones-stock-title">Acciones de stock</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <button class="btn acciones-stock-btn btn-accion-editar w-100 mb-2" id="btn-accion-editar">
            <span class="icono">‚úèÔ∏è</span>
            <span>Editar stock</span>
        </button>
        <button class="btn acciones-stock-btn btn-accion-agregar w-100 mb-2" id="btn-accion-agregar">
            <span class="icono">‚ûï</span>
            <span>Agregar stock</span>
        </button>
        <button class="btn acciones-stock-btn btn-accion-descontar w-100 mb-2" id="btn-accion-descontar">
            <span class="icono">‚ûñ</span>
            <span>Descontar stock</span>
        </button>
        <button class="btn acciones-stock-btn btn-accion-historial w-100" id="btn-accion-historial">
            <span class="icono">üìú</span>
            <span>Ver historial</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PACIENTE -->
<div class="modal fade" id="modalPaciente" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 id="modalTitle">Nuevo Registro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <input type="text" id="in-nombre" class="form-control mb-2" placeholder="Nombre completo">
                <input type="text" id="in-dni" class="form-control mb-2" placeholder="DNI">
                <input type="text" id="in-alergias" class="form-control mb-3" placeholder="Alergias (texto libre)">
                <h6>Prescripciones:</h6>
                <p class="small text-muted mb-1">
                    Dosis diaria en mg/mcg (puede ser decimal, ej.: 0.25). Presentaci√≥n = fuerza del comprimido (75, 100, 150, etc.). Para medicaci√≥n temporal activar ‚ÄúTemporaria‚Äù.
                </p>
                <div id="lista-prescripciones"></div>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="nuevaFila()">+ Otra droga</button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-100" onclick="guardarPaciente()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DETALLE PACIENTE -->
<div class="modal fade" id="modalDetallePaciente" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 id="detalle-title">Detalle del paciente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Nombre:</strong> <span id="detalle-nombre"></span></p>
        <p><strong>DNI:</strong> <span id="detalle-dni"></span></p>
        <p><strong>Alergias:</strong> <span id="detalle-alergias"></span></p>
        <p><strong>√öltima actualizaci√≥n:</strong> <span id="detalle-last"></span></p>
        <hr>
        <h6>Esquema de medicaci√≥n</h6>
        <div id="detalle-prescripciones"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL STOCK -->
<div class="modal fade" id="modalHistorialStock" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 id="historial-title">Historial de stock</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="historial-contenido"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CARRITO -->
<div class="modal fade" id="modalCarrito" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5>üõí Carrito de reposici√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="small mb-2">
          Medicamentos con menos de 5 d√≠as de cobertura. Se sugiere reponer hasta 10 d√≠as (cantidad calculada).
        </p>
        <ul id="carrito-lista" class="small mb-3"></ul>
        <button class="btn btn-dark w-100 mb-1" onclick="copiarCarrito()">Copiar faltantes</button>
        <div id="carrito-msg" class="small text-success mt-1"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const URL_BASE = 'https://695f043a7f037703a81290ad.mockapi.io/api/v1';
const RES_MEDS = 'Medications';
const RES_PATS = 'Patients';

let listadoMeds = [];
let listadoPats = [];
let modoOffline = true;

const DEFAULT_MG_PER_UNIT = 100;
const DIAS_MINIMOS = 5;
const DIAS_OBJETIVO = 10;

let medAccionesActualId = null;

/* Service Worker b√°sico */
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swCode = `
            const CACHE_NAME = 'stock-ba-v1';
            const OFFLINE_URLS = ['./'];

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME).then(cache => cache.addAll(OFFLINE_URLS))
                );
                self.skipWaiting();
            });

            self.addEventListener('activate', event => {
                event.waitUntil(
                    caches.keys().then(keys =>
                        Promise.all(
                            keys.map(k => k !== CACHE_NAME && caches.delete(k))
                        )
                    )
                );
                self.clients.claim();
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request).then(response => {
                        return response || fetch(event.request).then(netRes => {
                            const resClone = netRes.clone();
                            caches.open(CACHE_NAME).then(cache => {
                                cache.put(event.request, resClone);
                            });
                            return netRes;
                        }).catch(() => response);
                    })
                );
            });
        `;
        const blob = new Blob([swCode], { type: 'text/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).catch(console.error);
    });
}

/* Utilidades */
function parseDecimal(value) {
    if (value === null || value === undefined) return 0;
    if (typeof value === 'number') return value;
    const s = String(value).trim().replace(',', '.');
    const n = parseFloat(s);
    return Number.isNaN(n) ? 0 : n;
}

function getInitials(name) {
    if (!name) return '?';
    const parts = name.trim().split(/\s+/);
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    const first = parts[0].charAt(0).toUpperCase();
    const last = parts[parts.length - 1].charAt(0).toUpperCase();
    return first + last;
}

function getAvatarColor(name) {
    const colors = ['#ef4444','#f97316','#eab308','#22c55e','#0ea5e9','#6366f1','#a855f7','#ec4899'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    const index = Math.abs(hash) % colors.length;
    return colors[index];
}

/* Tabs bottom */
function activarTab(id) {
    const selector = '[data-bs-toggle="pill"][data-bs-target="#' + id + '"]';
    const tabElement = document.querySelector(selector);
    if (tabElement) {
        const tab = new bootstrap.Tab(tabElement);
        tab.show();
    }
    const btnPatsBottom = document.getElementById('tab-btn-pats-bottom');
    const btnStockBottom = document.getElementById('tab-btn-stock-bottom');
    btnPatsBottom.classList.remove('active');
    btnStockBottom.classList.remove('active');
    if (id === 'tab-pats') btnPatsBottom.classList.add('active');
    if (id === 'tab-stock') btnStockBottom.classList.add('active');
}

document.addEventListener('shown.bs.tab', function (event) {
    const targetId = event.target.getAttribute('data-bs-target');
    if (targetId === '#tab-pats') activarTab('tab-pats');
    if (targetId === '#tab-stock') activarTab('tab-stock');
});

/* Carga inicial */
async function iniciar() {
    try {
        const [rM, rP] = await Promise.all([
            fetch(URL_BASE + '/' + RES_MEDS),
            fetch(URL_BASE + '/' + RES_PATS)
        ]);
        if (rM.ok && rP.ok) {
            listadoMeds = await rM.json();
            listadoPats = await rP.json();
            modoOffline = false;
            document.getElementById('status-indicator').innerText = "Modo Online (API)";
        } else {
            usarCargaLocal();
        }
    } catch (e) {
        usarCargaLocal();
    }
    inicializarModalAccionesStock();
    renderizar();
}

function usarCargaLocal() {
    listadoMeds = JSON.parse(localStorage.getItem('local_meds')) || [];
    listadoPats = JSON.parse(localStorage.getItem('local_pats')) || [];
    document.getElementById('status-indicator').innerText = "Modo Local (Seguro)";
}

function persistirLocal() {
    localStorage.setItem('local_meds', JSON.stringify(listadoMeds));
    localStorage.setItem('local_pats', JSON.stringify(listadoPats));
}

function renderizar() {
    renderPacientesPlanilla();
    renderStock();
}

function imprimirPlanilla() {
    window.print();
}

/* Pacientes */
function renderPacientesPlanilla() {
    const cont = document.getElementById('lista-pacientes-planilla');
    cont.innerHTML = listadoPats.map(p => {
        const lastTxt = p.lastUpdated
            ? new Date(p.lastUpdated).toLocaleString('es-AR')
            : 'Sin registro';
        const nombre = p.name || '';
        const initials = getInitials(nombre);
        const avatarColor = getAvatarColor(nombre);
        const alergiasTxt = (p.allergies || '').trim();
        const alergiasMostrar = alergiasTxt ? '‚ö†Ô∏è ' + alergiasTxt : 'Sin datos';

        return '' +
        '<div class="card paciente-card shadow-sm p-3 p-md-4 border-2">' +
          '<div class="d-flex justify-content-between flex-wrap gap-2 mb-2">' +
            '<div class="d-flex align-items-start">' +
              '<div class="avatar-circle" style="background-color:' + avatarColor + ';">' +
                initials +
              '</div>' +
              '<div>' +
                '<div class="fw-semibold" style="font-size:1rem;">' + nombre + '</div>' +
                '<div class="small text-muted">DNI: ' + (p.dni || '') + '</div>' +
                '<div class="small text-muted">Alergias: ' + alergiasMostrar + '</div>' +
                '<div class="small text-muted mt-1">√öltima actualizaci√≥n: ' + lastTxt + '</div>' +
              '</div>' +
            '</div>' +
            '<div class="d-flex gap-2 flex-wrap" role="group" aria-label="Acciones para ' + nombre + '">' +
              '<button class="btn btn-light btn-sm btn-accion-paciente" type="button" onclick="abrirEdicion(\'' + p.id + '\')" aria-label="Editar datos de ' + nombre + '">‚úèÔ∏è Editar</button>' +
              '<button class="btn btn-info btn-sm btn-accion-paciente" type="button" onclick="verDetallePaciente(\'' + p.id + '\')" aria-label="Ver detalle de ' + nombre + '">üëÅ Detalle</button>' +
              '<button class="btn btn-danger btn-sm btn-accion-paciente" type="button" onclick="eliminarP(\'' + p.id + '\')" aria-label="Borrar registro de ' + nombre + '">üóë Borrar</button>' +
            '</div>' +
          '</div>' +
          '<div class="table-responsive rounded-4 overflow-hidden">' +
            '<table class="table table-dark table-sm table-bordered mb-0 planilla-inner-table">' +
              '<thead>' +
                '<tr>' +
                  '<th>Medicaci√≥n</th>' +
                  '<th>Dosis (mg/d√≠a)</th>' +
                  '<th>Ma√±ana (comp.)</th>' +
                  '<th>Tarde (comp.)</th>' +
                  '<th>Noche (comp.)</th>' +
                  '<th>Total d√≠a (comp.)</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' +
                ((p.prescriptions || []).length
                  ? (p.prescriptions || []).map(pr => {
                        const dosis = pr.dailyDosageMg || pr.dailyDosage || '';
                        const mTabs = parseDecimal(pr.morningTabs);
                        const aTabs = parseDecimal(pr.afternoonTabs);
                        const nTabs = parseDecimal(pr.nightTabs);
                        const totalTabs = mTabs + aTabs + nTabs;
                        const tempClass = pr.isTemporary ? 'temp-med-row temp-med-border' : '';
                        const labelTemp = pr.isTemporary ? ' (TEMP)' : '';
                        return '' +
                        '<tr class="' + tempClass + '">' +
                          '<td>' + (pr.medName || '') + (pr.strength ? ' (' + pr.strength + ')' : '') + labelTemp + '</td>' +
                          '<td>' + dosis + '</td>' +
                          '<td>' + mTabs + '</td>' +
                          '<td>' + aTabs + '</td>' +
                          '<td>' + nTabs + '</td>' +
                          '<td>' + totalTabs + '</td>' +
                        '</tr>';
                    }).join('')
                  : '<tr><td colspan="6" class="small text-muted text-center">Sin prescripciones</td></tr>'
                ) +
              '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>';
    }).join('');
}

/* Stock e inventario */
function calcularConsumoCompPorMed(m) {
    return listadoPats.reduce((acc, p) => {
        return acc + (p.prescriptions || []).reduce((subAcc, pr) => {
            if (pr.isTemporary) return subAcc;
            if (
                (pr.medName || '').toLowerCase() !== (m.name || '').toLowerCase() ||
                parseDecimal(pr.strength) !== parseDecimal(m.strength)
            ) return subAcc;
            const mgPerUnit = parseDecimal(pr.mgPerUnit) || parseDecimal(m.mgPerUnit) || DEFAULT_MG_PER_UNIT;
            const dosisDia = parseDecimal(pr.dailyDosageMg || pr.dailyDosage);
            const compDia = mgPerUnit > 0 ? dosisDia / mgPerUnit : 0;
            return subAcc + compDia;
        }, 0);
    }, 0);
}

function renderStock() {
    const tabla = document.getElementById('tabla-stock');
    tabla.innerHTML = listadoMeds.map(m => {
        const consumoComp = calcularConsumoCompPorMed(m);
        const stockNum = parseDecimal(m.stock);
        const dias = consumoComp > 0 ? Math.floor(stockNum / consumoComp) : 0;
        const hoy = new Date();
        const fechaFin = new Date(hoy);
        fechaFin.setDate(hoy.getDate() + dias);
        const fechaTxt = consumoComp > 0
            ? fechaFin.toLocaleDateString('es-AR', { day: '2-digit', month: 'long' })
            : '-';

        let colorStyle = 'background-color: #22c55e;';
        if (consumoComp > 0) {
            if (dias <= 5) {
                colorStyle = 'background-color: #ef4444;';
            } else if (dias <= 10) {
                colorStyle = 'background-color: #eab308;';
            }
        }

        const strengthTxt = m.strength ? String(m.strength) : (m.mgPerUnit || '');

        return '' +
        '<tr>' +
            '<td><strong>' + (m.name || '') + '</strong></td>' +
            '<td>' + strengthTxt + '</td>' +
            '<td>' + stockNum + '</td>' +
            '<td>' + consumoComp.toFixed(2) + '</td>' +
            '<td>' +
                '<div class="dia-count" style="' + colorStyle + '">' + dias + ' d√≠as</div>' +
                '<div class="small text-muted">Hasta: ' + fechaTxt + '</div>' +
            '</td>' +
            '<td>' +
                '<button class="btn btn-outline-light btn-icon" onclick="abrirAccionesStock(\'' + m.id + '\')" aria-label="Acciones de stock para ' + (m.name || '') + '">‚Ä¢‚Ä¢‚Ä¢</button>' +
            '</td>' +
        '</tr>';
    }).join('');
}

/* Modal de acciones stock */
function inicializarModalAccionesStock() {
    const btnEditar = document.getElementById('btn-accion-editar');
    const btnAgregar = document.getElementById('btn-accion-agregar');
    const btnDescontar = document.getElementById('btn-accion-descontar');
    const btnHistorial = document.getElementById('btn-accion-historial');

    [btnEditar, btnAgregar, btnDescontar, btnHistorial].forEach(btn => {
        btn.addEventListener('touchstart', () => btn.classList.add('is-active-touch'), {passive:true});
        btn.addEventListener('touchend', () => btn.classList.remove('is-active-touch'));
        btn.addEventListener('touchcancel', () => btn.classList.remove('is-active-touch'));
    });

    btnEditar.addEventListener('click', function() {
        const id = medAccionesActualId;
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccionesStock'));
        if (modal) modal.hide();
        if (id) editStock(id);
    });
    btnAgregar.addEventListener('click', function() {
        const id = medAccionesActualId;
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccionesStock'));
        if (modal) modal.hide();
        if (id) addStock(id);
    });
    btnDescontar.addEventListener('click', function() {
        const id = medAccionesActualId;
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccionesStock'));
        if (modal) modal.hide();
        if (id) subStock(id);
    });
    btnHistorial.addEventListener('click', function() {
        const id = medAccionesActualId;
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccionesStock'));
        if (modal) modal.hide();
        if (id) verHistorialStock(id);
    });
}

function abrirAccionesStock(id) {
    medAccionesActualId = id;
    const med = listadoMeds.find(m => m.id == id);
    const title = document.getElementById('acciones-stock-title');
    title.innerText = med ? ('Acciones: ' + med.name + ' ' + (med.strength || med.mgPerUnit || '')) : 'Acciones de stock';
    const modal = new bootstrap.Modal(document.getElementById('modalAccionesStock'));
    modal.show();
}

/* Editar / agregar / descontar / historial stock */
async function editStock(id) {
    const med = listadoMeds.find(x => x.id == id);
    if (!med) return;
    const actual = parseDecimal(med.stock);
    const val = prompt('Nuevo stock total (comprimidos):', actual);
    if (val === null) return;
    const nuevoStock = parseDecimal(val);
    if (Number.isNaN(nuevoStock) || nuevoStock < 0) return;
    const cambio = nuevoStock - actual;
    med.stock = nuevoStock;
    med.stockHistory = med.stockHistory || [];
    med.stockHistory.push({
        date: new Date().toISOString(),
        change: cambio,
        newStock: nuevoStock,
        type: 'set'
    });
    if (!modoOffline) {
        await fetch(URL_BASE + '/' + RES_MEDS + '/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock: nuevoStock, stockHistory: med.stockHistory })
        });
    }
    persistirLocal();
    renderStock();
}

async function addStock(id) {
    const med = listadoMeds.find(x => x.id == id);
    if (!med) return;
    const actual = parseDecimal(med.stock);
    const val = prompt('Cantidad a agregar (comprimidos):', '');
    if (val === null || val.trim() === '') return;
    const delta = parseDecimal(val);
    if (Number.isNaN(delta)) return;
    const nuevoStock = actual + delta;
    med.stock = nuevoStock;
    med.stockHistory = med.stockHistory || [];
    med.stockHistory.push({
        date: new Date().toISOString(),
        change: delta,
        newStock: nuevoStock,
        type: 'add'
    });
    if (!modoOffline) {
        await fetch(URL_BASE + '/' + RES_MEDS + '/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock: nuevoStock, stockHistory: med.stockHistory })
        });
    }
    persistirLocal();
    renderStock();
}

async function subStock(id) {
    const med = listadoMeds.find(x => x.id == id);
    if (!med) return;
    const actual = parseDecimal(med.stock);
    const val = prompt('Cantidad a descontar (comprimidos):', '');
    if (val === null || val.trim() === '') return;
    const delta = parseDecimal(val);
    if (Number.isNaN(delta) || delta < 0) return;
    const nuevoStock = Math.max(0, actual - delta);
    const cambio = nuevoStock - actual;
    med.stock = nuevoStock;
    med.stockHistory = med.stockHistory || [];
    med.stockHistory.push({
        date: new Date().toISOString(),
        change: cambio,
        newStock: nuevoStock,
        type: 'sub'
    });
    if (!modoOffline) {
        await fetch(URL_BASE + '/' + RES_MEDS + '/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock: nuevoStock, stockHistory: med.stockHistory })
        });
    }
    persistirLocal();
    renderStock();
}

function verHistorialStock(id) {
    const med = listadoMeds.find(x => x.id == id);
    if (!med) return;
    const hist = med.stockHistory || [];
    document.getElementById('historial-title').innerText =
        'Historial de ' + (med.name || '') + ' (' + (med.strength || med.mgPerUnit || '') + ')';
    const cont = document.getElementById('historial-contenido');
    if (!hist.length) {
        cont.innerHTML = '<p class="small text-muted">Sin movimientos registrados.</p>';
    } else {
        cont.innerHTML =
            '<div class="table-responsive rounded-4 overflow-hidden">' +
              '<table class="table table-sm table-dark table-bordered align-middle mb-0">' +
                '<thead>' +
                  '<tr>' +
                    '<th>Fecha</th>' +
                    '<th>Tipo</th>' +
                    '<th>Cambio</th>' +
                    '<th>Stock resultante</th>' +
                  '</tr>' +
                '</thead>' +
                '<tbody>' +
                  hist.slice().reverse().map(h => {
                    let tipo = 'Seteo';
                    if (h.type === 'add') tipo = 'Reposici√≥n';
                    else if (h.type === 'sub') tipo = 'Descuento';
                    return '' +
                      '<tr>' +
                        '<td>' + new Date(h.date).toLocaleString('es-AR') + '</td>' +
                        '<td>' + tipo + '</td>' +
                        '<td>' + (h.change > 0 ? '+' + h.change : h.change) + '</td>' +
                        '<td>' + h.newStock + '</td>' +
                      '</tr>';
                  }).join('') +
                '</tbody>' +
              '</table>' +
            '</div>';
    }
    new bootstrap.Modal('#modalHistorialStock').show();
}

/* Carrito */
function obtenerItemsCarrito() {
    const items = [];
    listadoMeds.forEach(m => {
        const consumo = calcularConsumoCompPorMed(m);
        if (consumo <= 0) return;
        const stock = parseDecimal(m.stock);
        const dias = stock / consumo;
        if (dias < DIAS_MINIMOS) {
            const falta = Math.max(0, Math.ceil(DIAS_OBJETIVO * consumo - stock));
            items.push({
                nombre: m.name,
                strength: m.strength || m.mgPerUnit || '',
                falta: falta
            });
        }
    });
    return items;
}

function abrirCarrito() {
    const lista = document.getElementById('carrito-lista');
    const items = obtenerItemsCarrito();
    if (!items.length) {
        lista.innerHTML = '<li class="text-muted">No hay medicamentos por debajo de 5 d√≠as.</li>';
    } else {
        lista.innerHTML = items.map(it =>
            '<li>' + it.nombre + (it.strength ? ' ' + it.strength : '') + ' (' + it.falta + ')</li>'
        ).join('');
    }
    document.getElementById('carrito-msg').innerText = '';
    new bootstrap.Modal('#modalCarrito').show();
}

async function copiarCarrito() {
    const items = obtenerItemsCarrito();
    if (!items.length) {
        document.getElementById('carrito-msg').innerText = 'No hay nada para copiar.';
        return;
    }
    const texto = items.map(it =>
        it.nombre + (it.strength ? ' ' + it.strength : '') + ' (' + it.falta + ')'
    ).join(', ');
    try {
        if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(texto);
            document.getElementById('carrito-msg').innerText = 'Copiado al portapapeles.';
        } else {
            document.getElementById('carrito-msg').innerText = 'Clipboard no disponible en este navegador.';
        }
    } catch (e) {
        document.getElementById('carrito-msg').innerText = 'No se pudo copiar.';
    }
}

/* Alta / edici√≥n paciente */
function abrirModal() {
    document.getElementById('modalTitle').innerText = 'Nuevo Registro';
    document.getElementById('edit-id').value = '';
    document.getElementById('in-nombre').value = '';
    document.getElementById('in-dni').value = '';
    document.getElementById('in-alergias').value = '';
    document.getElementById('lista-prescripciones').innerHTML = '';
    nuevaFila();
    new bootstrap.Modal('#modalPaciente').show();
}

function abrirEdicion(id) {
    const p = listadoPats.find(x => x.id == id);
    if (!p) return;
    document.getElementById('modalTitle').innerText = 'Editar paciente';
    document.getElementById('edit-id').value = p.id;
    document.getElementById('in-nombre').value = p.name || '';
    document.getElementById('in-dni').value = p.dni || '';
    document.getElementById('in-alergias').value = p.allergies || '';

    const cont = document.getElementById('lista-prescripciones');
    cont.innerHTML = '';
    (p.prescriptions || []).forEach(pr => {
        nuevaFila(
            pr.medName || '',
            pr.dailyDosageMg || pr.dailyDosage || '',
            pr.strength || '',
            pr.mgPerUnit || '',
            pr.timesPerDay || '',
            pr.shift || '',
            pr.morningTabs || '',
            pr.afternoonTabs || '',
            pr.nightTabs || '',
            !!pr.isTemporary
        );
    });
    if (!(p.prescriptions || []).length) nuevaFila();
    new bootstrap.Modal('#modalPaciente').show();
}

function nuevaFila(
    n = '', d = '', strength = '', mgUnit = '', times = '', shift = '',
    mTabs = '', aTabs = '', nTabs = '', isTemp = false
) {
    const cont = document.getElementById('lista-prescripciones');
    const idx = cont.children.length;
    const fila = document.createElement('div');
    fila.className = 'border rounded-3 p-2 mb-2';
    fila.innerHTML = `
        <div class="row g-2 align-items-end">
            <div class="col-6">
                <label class="form-label small">Droga</label>
                <input type="text" class="form-control in-medName" value="${n}">
            </div>
            <div class="col-3">
                <label class="form-label small">Fuerza</label>
                <input type="text" class="form-control in-strength" value="${strength}">
            </div>
            <div class="col-3">
                <label class="form-label small">mg por comp.</label>
                <input type="text" class="form-control in-mgUnit" value="${mgUnit}">
            </div>
            <div class="col-4">
                <label class="form-label small">Dosis diaria (mg)</label>
                <input type="text" class="form-control in-dosis" value="${d}">
            </div>
            <div class="col-2">
                <label class="form-label small">Ma√±ana</label>
                <input type="text" class="form-control in-mTabs" value="${mTabs}">
            </div>
            <div class="col-2">
                <label class="form-label small">Tarde</label>
                <input type="text" class="form-control in-aTabs" value="${aTabs}">
            </div>
            <div class="col-2">
                <label class="form-label small">Noche</label>
                <input type="text" class="form-control in-nTabs" value="${nTabs}">
            </div>
            <div class="col-2">
                <div class="form-check mt-4">
                    <input class="form-check-input in-temp" type="checkbox" ${isTemp ? 'checked' : ''} id="temp-${idx}">
                    <label class="form-check-label small" for="temp-${idx}">
                        Temporaria
                    </label>
                </div>
            </div>
            <div class="col-12 text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarFila(this)">Quitar</button>
            </div>
        </div>
    `;
    cont.appendChild(fila);
}

function eliminarFila(btn) {
    const fila = btn.closest('.border');
    if (fila && fila.parentNode) fila.parentNode.removeChild(fila);
}

async function guardarPaciente() {
    const id = document.getElementById('edit-id').value || null;
    const nombre = document.getElementById('in-nombre').value.trim();
    const dni = document.getElementById('in-dni').value.trim();
    const alergias = document.getElementById('in-alergias').value.trim();

    if (!nombre) {
        alert('El nombre es obligatorio');
        return;
    }

    const pres = [];
    document.querySelectorAll('#lista-prescripciones > div').forEach(div => {
        const medName = div.querySelector('.in-medName').value.trim();
        const strength = div.querySelector('.in-strength').value.trim();
        const mgPerUnit = div.querySelector('.in-mgUnit').value.trim();
        const dosis = div.querySelector('.in-dosis').value.trim();
        const mTabs = div.querySelector('.in-mTabs').value.trim();
        const aTabs = div.querySelector('.in-aTabs').value.trim();
        const nTabs = div.querySelector('.in-nTabs').value.trim();
        const isTemp = div.querySelector('.in-temp').checked;

        if (!medName && !dosis) return;

        pres.push({
            medName,
            strength,
            mgPerUnit,
            dailyDosageMg: parseDecimal(dosis),
            morningTabs: parseDecimal(mTabs),
            afternoonTabs: parseDecimal(aTabs),
            nightTabs: parseDecimal(nTabs),
            isTemporary: isTemp
        });
    });

    const payload = {
        name: nombre,
        dni,
        allergies: alergias,
        prescriptions: pres,
        lastUpdated: new Date().toISOString()
    };

    if (id) {
        const idx = listadoPats.findIndex(p => p.id == id);
        if (idx === -1) return;
        listadoPats[idx] = { ...listadoPats[idx], ...payload };
        if (!modoOffline) {
            await fetch(URL_BASE + '/' + RES_PATS + '/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(listadoPats[idx])
            });
        }
    } else {
        const nuevo = { ...payload };
        if (!modoOffline) {
            const resp = await fetch(URL_BASE + '/' + RES_PATS, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nuevo)
            });
            const creado = await resp.json();
            nuevo.id = creado.id;
        } else {
            nuevo.id = 'local-' + Date.now();
        }
        listadoPats.push(nuevo);
    }

    persistirLocal();
    renderPacientesPlanilla();
    renderStock();

    const modal = bootstrap.Modal.getInstance(document.getElementById('modalPaciente'));
    if (modal) modal.hide();
}

async function eliminarP(id) {
    if (!confirm('¬øSeguro que quer√©s borrar este paciente?')) return;
    listadoPats = listadoPats.filter(p => p.id != id);
    if (!modoOffline) {
        await fetch(URL_BASE + '/' + RES_PATS + '/' + id, { method: 'DELETE' });
    }
    persistirLocal();
    renderPacientesPlanilla();
    renderStock();
}

function verDetallePaciente(id) {
    const p = listadoPats.find(x => x.id == id);
    if (!p) return;
    document.getElementById('detalle-title').innerText = 'Detalle del paciente';
    document.getElementById('detalle-nombre').innerText = p.name || '';
    document.getElementById('detalle-dni').innerText = p.dni || '';
    document.getElementById('detalle-alergias').innerText =
        (p.allergies && p.allergies.trim()) ? p.allergies : 'Sin datos';
    document.getElementById('detalle-last').innerText =
        p.lastUpdated ? new Date(p.lastUpdated).toLocaleString('es-AR') : 'Sin registro';

    const cont = document.getElementById('detalle-prescripciones');
    if (!(p.prescriptions || []).length) {
        cont.innerHTML = '<p class="small text-muted">Sin prescripciones.</p>';
    } else {
        cont.innerHTML = `
            <div class="table-responsive rounded-4 overflow-hidden">
                <table class="table table-dark table-sm table-bordered mb-0">
                    <thead>
                        <tr>
                            <th>Medicaci√≥n</th>
                            <th>Dosis (mg/d√≠a)</th>
                            <th>Ma√±ana</th>
                            <th>Tarde</th>
                            <th>Noche</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${p.prescriptions.map(pr => `
                            <tr class="${pr.isTemporary ? 'temp-med-row temp-med-border' : ''}">
                                <td>${pr.medName || ''} ${pr.strength ? '(' + pr.strength + ')' : ''} ${pr.isTemporary ? 'TEMP' : ''}</td>
                                <td>${pr.dailyDosageMg || pr.dailyDosage || ''}</td>
                                <td>${parseDecimal(pr.morningTabs)}</td>
                                <td>${parseDecimal(pr.afternoonTabs)}</td>
                                <td>${parseDecimal(pr.nightTabs)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    new bootstrap.Modal('#modalDetallePaciente').show();
}

iniciar();
</script>
</body>
</html>
